<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Aleda" />
        <meta name="copyright" content="Aleda" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="code-reading, experience, code-reading, " />

<meta property="og:title" content="web.py "/>
<meta property="og:url" content="http://aleda.cn/article/2015/08/web.py/" />
<meta property="og:description" content="web.py" />
<meta property="og:site_name" content="Aleda | Make Different" />
<meta property="og:article:author" content="Aleda" />
<meta property="og:article:published_time" content="2015-08-30T22:22:00+08:00" />
<meta name="twitter:title" content="web.py ">
<meta name="twitter:description" content="web.py">

        <title>web.py  · Aleda | Make Different
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://aleda.cn/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://aleda.cn/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://aleda.cn/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://aleda.cn/theme/css/custom.css" media="screen">
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://aleda.cn/"><span class=site-name><span style="color:black;">Aleda</span> |  <span style="color:#AA1032;"> Make Different </span></span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://aleda.cn">Home</a></li>
                            <li ><a href="http://aleda.cn/categories.html">Categories</a></li>
                            <li ><a href="http://aleda.cn/tags.html">Tags</a></li>
                            <li ><a href="http://aleda.cn/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://aleda.cn/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="http://aleda.cn/article/2015/08/web.py/"> web.py  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <h1>web.py</h1>
<h2><strong>Table of Contents</strong></h2>
<ul>
<li><a href="#1"><strong>1 web.py</strong></a>    <ul>
<li><a href="#1.1"><strong>1.1 Introduction</strong></a>    </li>
<li><a href="#1.2"><strong>1.2 Feature</strong></a>   </li>
<li><a href="#1.3"><strong>1.3 Code Analysis</strong></a><ul>
<li><a href="#1.3.1"><strong>1.3.1 utils.py</strong></a></li>
<li><a href="#1.3.2"><strong>1.3.2 webapi.py</strong></a></li>
<li><a href="#1.3.3"><strong>1.3.3 application.py</strong></a></li>
<li><a href="#1.3.4"><strong>1.3.4 wsgiserver</strong></a></li>
<li><a href="#1.3.5"><strong>1.3.5 net.py</strong></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><strong>1 web.py</strong></h2>
<p>web.py是一个用python写的一个轻量级的HTTP服务器。  <br />
详细请看:<br />
<a href="http://webpy.org/">http://webpy.org/</a>  <br />
github: <br />
<a href="https://github.com/webpy/webpy">https://github.com/webpy/webpy</a>  <br />
另，附上cherrypy实现的WSGIServer: <br />
<a href="http://www.cherrypy.org/">http://www.cherrypy.org/</a></p>
<h3><strong>1.1 Introduction</strong><span id="1.1"></span></h3>
<p>Webpy是在cherrypy WSGIHTTPServer的基础上进行了一些列的封装和容错，日志，配置等的封装上的一个轻量Http 服务实现，两位作者都很牛，Webpy的作者实现的util等lib我个人用的非常爽，包括一些设计方法，非常的pythonic。<br />
cherrypy的Server写的也很细心，而且逻辑非常清楚，像我这种菜鸟也能很快的掌握其中的核心设计（难道是因为我自己实现过rpc的原因？）。  </p>
<h3><strong>1.2 Feature</strong><span id="1.2"></span></h3>
<p>Webpy 支持对不同的HTTP route、socket，cgi、socket的处理，只需要写好相应的handler就可以使用。</p>
<h3><strong>1.3 Code Analysis</strong><span id="1.3"></span></h3>
<h4><strong>1.3.1 utils.py</strong><span id="1.3.1"></span></h4>
<p>饭要一口一口吃，代码要一行一行的看，不能急于求成，步子太大了，容易——咔，扯着蛋。0.-!
咔咔咔，看了这些utils，已经成功转化成我的lib&amp;&amp;__为我所用__了。   </p>
<p>utils是一个工具包，web.py里面的所有公用工具函数、类都在这里实现，先让我们快速的把这些代码过一下。   </p>
<p>class Storage是一个inherit dict的一个class，注释写的很清楚了，是一个提供两种方式（<strong>getattr</strong> &amp; <strong>getitem</strong>）获得member variables的包装class；   </p>
<div class="highlight"><pre><span class="k">class</span> <span class="n">Storage</span>(<span class="n">dict</span>):
    <span class="s">&quot;&quot;&quot;</span>
<span class="s">    A Storage object is like a dictionary except `obj.foo` can be used</span>
<span class="s">    in addition to `obj[&#39;foo&#39;]`.</span>

<span class="s">        &gt;&gt;&gt; o = storage(a=1)</span>
<span class="s">        &gt;&gt;&gt; o.a</span>
<span class="s">        1</span>
<span class="s">        &gt;&gt;&gt; o[&#39;a&#39;]</span>
<span class="s">        1</span>
<span class="s">        &gt;&gt;&gt; o.a = 2</span>
<span class="s">        &gt;&gt;&gt; o[&#39;a&#39;]</span>
<span class="s">        2</span>
<span class="s">        &gt;&gt;&gt; del o.a</span>
<span class="s">        &gt;&gt;&gt; o.a</span>
<span class="s">        Traceback (most recent call last):</span>
<span class="s">            ...</span>
<span class="s">        AttributeError: &#39;a&#39;</span>

<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">def</span> <span class="n">__getattr__</span>(<span class="k">self</span>, <span class="nb">key</span>): 
        <span class="n">try:</span>
            <span class="k">return</span> <span class="k">self</span>[<span class="nb">key</span>]
        <span class="n">except</span> <span class="n">KeyError</span>, <span class="n">k:</span>
            <span class="n">raise</span> <span class="n">AttributeError</span>, <span class="n">k</span>

    <span class="n">def</span> <span class="n">__setattr__</span>(<span class="k">self</span>, <span class="nb">key</span>, <span class="nb">value</span>): 
        <span class="k">self</span>[<span class="nb">key</span>] = <span class="nb">value</span>

    <span class="n">def</span> <span class="n">__delattr__</span>(<span class="k">self</span>, <span class="nb">key</span>):
        <span class="n">try:</span>
            <span class="n">del</span> <span class="k">self</span>[<span class="nb">key</span>]
        <span class="n">except</span> <span class="n">KeyError</span>, <span class="n">k:</span>
            <span class="n">raise</span> <span class="n">AttributeError</span>, <span class="n">k</span>

    <span class="n">def</span> <span class="n">__repr__</span>(<span class="k">self</span>):     
    <span class="k">return</span> <span class="s">&#39;&lt;Storage &#39;</span> + <span class="n">dict</span>.<span class="n">__repr__</span>(<span class="k">self</span>) + <span class="s">&#39;&gt;&#39;</span>
</pre></div>


<p>func storify通过mapping映射成Storage，其中有一些转换的策略，看注释，代码不传； <br />
class Counter继承自Storage，是一个提供add方法加入key，并累加add次数到value的一个统计class，并且提供sort，persent，most等多种统计方式。   </p>
<div class="highlight"><pre><span class="k">class</span> <span class="n">Counter</span>(<span class="n">storage</span>):
    <span class="s">&quot;&quot;&quot;Keeps count of how many times something is added.</span>

<span class="s">        &gt;&gt;&gt; c = counter()</span>
<span class="s">        &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">        &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">        &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">        &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">        &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">        &gt;&gt;&gt; c.add(&#39;y&#39;)</span>
<span class="s">        &gt;&gt;&gt; c</span>
<span class="s">        &lt;Counter {&#39;y&#39;: 1, &#39;x&#39;: 5}&gt;</span>
<span class="s">        &gt;&gt;&gt; c.most()</span>
<span class="s">        [&#39;x&#39;]</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">def</span> <span class="n">add</span>(<span class="k">self</span>, <span class="n">n</span>):
        <span class="k">self</span>.<span class="n">setdefault</span>(<span class="n">n</span>, <span class="mi">0</span>)
        <span class="k">self</span>[<span class="n">n</span>] += <span class="mi">1</span>

    <span class="n">def</span> <span class="n">most</span>(<span class="k">self</span>):
        <span class="s">&quot;&quot;&quot;Returns the keys with maximum count.&quot;&quot;&quot;</span>
        <span class="sr">m = max(self.itervalues())</span>
<span class="sr">        return [k for k, v in self.iteritems() if v =</span>= <span class="sr">m]</span>

<span class="sr">    def least(self):</span>
<span class="sr">        &quot;&quot;&quot;Returns the keys with mininum count.&quot;&quot;&quot;</span>
<span class="sr">        m = min(self.itervalues())</span>
<span class="sr">        return [k for k, v in self.iteritems() if v == m]</span>

    <span class="n">def</span> <span class="n">percent</span>(<span class="k">self</span>, <span class="nb">key</span>):
       <span class="s">&quot;&quot;&quot;Returns what percentage a certain key is of all entries.</span>

<span class="s">           &gt;&gt;&gt; c = counter()</span>
<span class="s">           &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">           &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">           &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">           &gt;&gt;&gt; c.add(&#39;y&#39;)</span>
<span class="s">           &gt;&gt;&gt; c.percent(&#39;x&#39;)</span>
<span class="s">           0.75</span>
<span class="s">           &gt;&gt;&gt; c.percent(&#39;y&#39;)</span>
<span class="s">           0.25</span>
<span class="s">       &quot;&quot;&quot;</span>
       <span class="k">return</span> <span class="n">float</span>(<span class="k">self</span>[<span class="nb">key</span>])/<span class="nb">sum</span>(<span class="k">self</span>.<span class="nb">values</span>())

    <span class="n">def</span> <span class="n">sorted_keys</span>(<span class="k">self</span>):
        <span class="s">&quot;&quot;&quot;Returns keys sorted by value.</span>

<span class="s">             &gt;&gt;&gt; c = counter()</span>
<span class="s">             &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">             &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">             &gt;&gt;&gt; c.add(&#39;y&#39;)</span>
<span class="s">             &gt;&gt;&gt; c.sorted_keys()</span>
<span class="s">             [&#39;x&#39;, &#39;y&#39;]</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sorted</span>(<span class="k">self</span>.<span class="nb">keys</span>(), <span class="nb">key</span>=<span class="n">lambda</span> <span class="n">k:</span> <span class="k">self</span>[<span class="n">k</span>], <span class="nb">reverse</span>=<span class="nb">True</span>)

    <span class="n">def</span> <span class="n">sorted_values</span>(<span class="k">self</span>):
        <span class="s">&quot;&quot;&quot;Returns values sorted by value.</span>

<span class="s">            &gt;&gt;&gt; c = counter()</span>
<span class="s">            &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">            &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">            &gt;&gt;&gt; c.add(&#39;y&#39;)</span>
<span class="s">            &gt;&gt;&gt; c.sorted_values()</span>
<span class="s">            [2, 1]</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="k">return</span> [<span class="k">self</span>[<span class="n">k</span>] <span class="k">for</span> <span class="n">k</span> <span class="n">in</span> <span class="k">self</span>.<span class="n">sorted_keys</span>()]

    <span class="n">def</span> <span class="n">sorted_items</span>(<span class="k">self</span>):
        <span class="s">&quot;&quot;&quot;Returns items sorted by value.</span>

<span class="s">            &gt;&gt;&gt; c = counter()</span>
<span class="s">            &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">            &gt;&gt;&gt; c.add(&#39;x&#39;)</span>
<span class="s">            &gt;&gt;&gt; c.add(&#39;y&#39;)</span>
<span class="s">            &gt;&gt;&gt; c.sorted_items()</span>
<span class="s">            [(&#39;x&#39;, 2), (&#39;y&#39;, 1)]</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="k">return</span> [(<span class="n">k</span>, <span class="k">self</span>[<span class="n">k</span>]) <span class="k">for</span> <span class="n">k</span> <span class="n">in</span> <span class="k">self</span>.<span class="n">sorted_keys</span>()]

    <span class="n">def</span> <span class="n">__repr__</span>(<span class="k">self</span>):
        <span class="k">return</span> <span class="s">&#39;&lt;Counter &#39;</span> + <span class="n">dict</span>.<span class="n">__repr__</span>(<span class="k">self</span>) + <span class="s">&#39;&gt;&#39;</span>
</pre></div>


<p>提供了一个配套的strips，不仅可以删除pat的字符串，对于一个pat的可以iter（list、tuple、set）的结构都可以删除，看代码；   </p>
<div class="highlight"><pre><span class="s-Atom">iters</span> <span class="o">=</span> <span class="p">[</span><span class="s-Atom">list</span><span class="p">,</span> <span class="s-Atom">tuple</span><span class="p">]</span>
<span class="s-Atom">import</span> <span class="k">__</span><span class="s-Atom">builtin__</span>
<span class="s-Atom">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="k">__</span><span class="s-Atom">builtin__</span><span class="p">,</span> <span class="s-Atom">&#39;set&#39;</span><span class="p">)</span><span class="s-Atom">:</span>
    <span class="s-Atom">iters</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s-Atom">set</span><span class="p">)</span>
<span class="s-Atom">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="k">__</span><span class="s-Atom">builtin__</span><span class="p">,</span> <span class="s-Atom">&#39;frozenset&#39;</span><span class="p">)</span><span class="s-Atom">:</span>
    <span class="s-Atom">iters</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s-Atom">set</span><span class="p">)</span>
<span class="s-Atom">if</span> <span class="s-Atom">sys</span><span class="p">.</span><span class="s-Atom">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="s-Atom">:</span> <span class="s-Atom">#</span> <span class="s-Atom">sets</span> <span class="s-Atom">module</span> <span class="s-Atom">deprecated</span> <span class="s-Atom">in</span> <span class="mf">2.6</span>
    <span class="nn">try</span><span class="p">:</span>
        <span class="s-Atom">from</span> <span class="s-Atom">sets</span> <span class="s-Atom">import</span> <span class="nv">Set</span>
        <span class="s-Atom">iters</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nv">Set</span><span class="p">)</span>
    <span class="s-Atom">except</span> <span class="nv">ImportError</span><span class="s-Atom">:</span> 
        <span class="s-Atom">pass</span>

<span class="s-Atom">class</span> <span class="k">_</span><span class="nf">hack</span><span class="p">(</span><span class="s-Atom">tuple</span><span class="p">)</span><span class="s-Atom">:</span> <span class="s-Atom">pass</span>
<span class="s-Atom">iters</span> <span class="o">=</span> <span class="k">_</span><span class="nf">hack</span><span class="p">(</span><span class="s-Atom">iters</span><span class="p">)</span>
<span class="s-Atom">iters</span><span class="p">.</span><span class="k">__</span><span class="s-Atom">doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">A list of iterable items (like lists, but not strings). Includes whichever</span>
<span class="s2">of lists, tuples, sets, and Sets are available in this version of Python.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="s-Atom">def</span> <span class="k">_</span><span class="nf">strips</span><span class="p">(</span><span class="s-Atom">direction</span><span class="p">,</span> <span class="s-Atom">text</span><span class="p">,</span> <span class="s-Atom">remove</span><span class="p">)</span><span class="s-Atom">:</span>
    <span class="s-Atom">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="s-Atom">remove</span><span class="p">,</span> <span class="s-Atom">iters</span><span class="p">)</span><span class="s-Atom">:</span>
        <span class="s-Atom">for</span> <span class="s-Atom">subr</span> <span class="s-Atom">in</span> <span class="nn">remove</span><span class="p">:</span>
            <span class="s-Atom">text</span> <span class="o">=</span> <span class="k">_</span><span class="nf">strips</span><span class="p">(</span><span class="s-Atom">direction</span><span class="p">,</span> <span class="s-Atom">text</span><span class="p">,</span> <span class="s-Atom">subr</span><span class="p">)</span>
        <span class="s-Atom">return</span> <span class="s-Atom">text</span>

    <span class="s-Atom">if</span> <span class="s-Atom">direction</span> <span class="o">==</span> <span class="s-Atom">&#39;l&#39;:</span> 
        <span class="s-Atom">if</span> <span class="s-Atom">text</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="s-Atom">remove</span><span class="p">)</span><span class="s-Atom">:</span> 
            <span class="s-Atom">return</span> <span class="s-Atom">text</span><span class="p">[</span><span class="nf">len</span><span class="p">(</span><span class="s-Atom">remove</span><span class="p">)</span><span class="s-Atom">:</span><span class="p">]</span>
    <span class="s-Atom">elif</span> <span class="s-Atom">direction</span> <span class="o">==</span> <span class="s-Atom">&#39;r&#39;:</span>
        <span class="s-Atom">if</span> <span class="s-Atom">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="s-Atom">remove</span><span class="p">)</span><span class="s-Atom">:</span>   
            <span class="s-Atom">return</span> <span class="s-Atom">text</span><span class="p">[:-</span><span class="nf">len</span><span class="p">(</span><span class="s-Atom">remove</span><span class="p">)]</span>
    <span class="nn">else</span><span class="p">:</span> 
        <span class="s-Atom">raise</span> <span class="nv">ValueError</span><span class="p">,</span> <span class="s2">&quot;Direction needs to be r or l.&quot;</span>
    <span class="s-Atom">return</span> <span class="s-Atom">text</span>

<span class="s-Atom">def</span> <span class="nf">rstrips</span><span class="p">(</span><span class="s-Atom">text</span><span class="p">,</span> <span class="s-Atom">remove</span><span class="p">)</span><span class="s-Atom">:</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    removes the string `remove` from the right of `text`</span>

<span class="s2">        &gt;&gt;&gt; rstrips(&quot;</span><span class="s-Atom">foobar</span><span class="s2">&quot;, &quot;</span><span class="s-Atom">bar</span><span class="s2">&quot;)</span>
<span class="s2">        &#39;foo&#39;</span>

<span class="s2">    &quot;&quot;&quot;</span>
    <span class="s-Atom">return</span> <span class="k">_</span><span class="nf">strips</span><span class="p">(</span><span class="s-Atom">&#39;r&#39;</span><span class="p">,</span> <span class="s-Atom">text</span><span class="p">,</span> <span class="s-Atom">remove</span><span class="p">)</span>

<span class="s-Atom">def</span> <span class="nf">lstrips</span><span class="p">(</span><span class="s-Atom">text</span><span class="p">,</span> <span class="s-Atom">remove</span><span class="p">)</span><span class="s-Atom">:</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    removes the string `remove` from the left of `text`</span>

<span class="s2">        &gt;&gt;&gt; lstrips(&quot;</span><span class="s-Atom">foobar</span><span class="s2">&quot;, &quot;</span><span class="s-Atom">foo</span><span class="s2">&quot;)</span>
<span class="s2">        &#39;bar&#39;</span>
<span class="s2">        &gt;&gt;&gt; lstrips(&#39;http://foo.org/&#39;, [&#39;http://&#39;, &#39;https://&#39;])</span>
<span class="s2">        &#39;foo.org/&#39;</span>
<span class="s2">        &gt;&gt;&gt; lstrips(&#39;FOOBARBAZ&#39;, [&#39;FOO&#39;, &#39;BAR&#39;])</span>
<span class="s2">        &#39;BAZ&#39;</span>
<span class="s2">        &gt;&gt;&gt; lstrips(&#39;FOOBARBAZ&#39;, [&#39;BAR&#39;, &#39;FOO&#39;])</span>
<span class="s2">        &#39;BARBAZ&#39;</span>

<span class="s2">    &quot;&quot;&quot;</span>
    <span class="s-Atom">return</span> <span class="k">_</span><span class="nf">strips</span><span class="p">(</span><span class="s-Atom">&#39;l&#39;</span><span class="p">,</span> <span class="s-Atom">text</span><span class="p">,</span> <span class="s-Atom">remove</span><span class="p">)</span>

<span class="s-Atom">def</span> <span class="nf">strips</span><span class="p">(</span><span class="s-Atom">text</span><span class="p">,</span> <span class="s-Atom">remove</span><span class="p">)</span><span class="s-Atom">:</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    removes the string `remove` from the both sides of `text`</span>

<span class="s2">        &gt;&gt;&gt; strips(&quot;</span><span class="s-Atom">foobarfoo</span><span class="s2">&quot;, &quot;</span><span class="s-Atom">foo</span><span class="s2">&quot;)</span>
<span class="s2">        &#39;bar&#39;</span>

<span class="s2">    &quot;&quot;&quot;</span>
    <span class="s-Atom">return</span> <span class="nf">rstrips</span><span class="p">(</span><span class="nf">lstrips</span><span class="p">(</span><span class="s-Atom">text</span><span class="p">,</span> <span class="s-Atom">remove</span><span class="p">),</span> <span class="s-Atom">remove</span><span class="p">)</span>
</pre></div>


<p>提供了两个safe convertion转换到unicode和string，挺具有指导意义的：   </p>
<div class="highlight"><pre>def safeunicode(obj, encoding=&#39;utf-8&#39;):
    r&quot;&quot;&quot;
    Converts any given object to unicode string.

        &gt;&gt;&gt; safeunicode(&#39;hello&#39;)
        u&#39;hello&#39;
        &gt;&gt;&gt; safeunicode(2)
        u&#39;2&#39;
        &gt;&gt;&gt; safeunicode(&#39;\xe1\x88\xb4&#39;)
        u&#39;\u1234&#39;
    &quot;&quot;&quot;
    t = type(obj)
    if t is unicode:
        return obj
    elif t is str:
        return obj.decode(encoding)
    elif t in [int, float, bool]:
        return unicode(obj)
    elif hasattr(obj, &#39;__unicode__&#39;) or isinstance(obj, unicode):
        return unicode(obj)
    else:
        return str(obj).decode(encoding)

def safestr(obj, encoding=&#39;utf-8&#39;):
    r&quot;&quot;&quot;
    Converts any given object to utf-8 encoded string.

        &gt;&gt;&gt; safestr(&#39;hello&#39;)
        &#39;hello&#39;
        &gt;&gt;&gt; safestr(u&#39;\u1234&#39;)
        &#39;\xe1\x88\xb4&#39;
        &gt;&gt;&gt; safestr(2)
        &#39;2&#39;
    &quot;&quot;&quot;
    if isinstance(obj, unicode):
        return obj.encode(encoding)
    elif isinstance(obj, str):
        return obj
    elif hasattr(obj, &#39;next&#39;): # iterator
        return itertools.imap(safestr, obj)
    else:
        return str(obj)
</pre></div>


<p>检验超时的函数，利用一个带有timeout的监控线程取约束执行方法的时间，超时的就抛出异常，但是，却并不能关闭执行的线程，不过这思想已然非常好了，无可厚非——2.*的python中的线程本身就不能kill，sign。   </p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">def</span> <span class="nf">timelimit</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A decorator to limit a function to `timeout` seconds, raising `TimeoutError`</span>
<span class="sd">    if it takes longer.</span>

<span class="sd">        &gt;&gt;&gt; import time</span>
<span class="sd">        &gt;&gt;&gt; def meaningoflife():</span>
<span class="sd">        ...     time.sleep(.2)</span>
<span class="sd">        ...     return 42</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        &gt;&gt;&gt; timelimit(.1)(meaningoflife)()</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">            ...</span>
<span class="sd">        TimeoutError: took too long</span>
<span class="sd">        &gt;&gt;&gt; timelimit(1)(meaningoflife)()</span>
<span class="sd">        42</span>

<span class="sd">    _Caveat:_ The function isn&#39;t stopped after `timeout` seconds but continues </span>
<span class="sd">    executing in a separate thread. (There seems to be no way to kill a thread.)</span>

<span class="sd">    inspired by &lt;http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/473878&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_1</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_2</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">class</span> <span class="nc">Dispatch</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="bp">None</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

                <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

            <span class="n">c</span> <span class="o">=</span> <span class="n">Dispatch</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">TimeoutError</span><span class="p">,</span> <span class="s">&#39;took too long&#39;</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">c</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">result</span>
        <span class="k">return</span> <span class="n">_2</span>
    <span class="k">return</span> <span class="n">_1</span>
</pre></div>


<p>将iterator按照size分组，这个generator写的真是很精华，值得学习：   </p>
<div class="highlight"><pre>def group(seq, size): 
    &quot;&quot;&quot;
    Returns an iterator over a series of lists of length size from iterable.

        &gt;&gt;&gt; list(group([1,2,3,4], 2))
        [[1, 2], [3, 4]]
        &gt;&gt;&gt; list(group([1,2,3,4,5], 2))
        [[1, 2], [3, 4], [5]]
    &quot;&quot;&quot;
    def take(seq, n):
        for i in xrange(n):
            yield seq.next()

    if not hasattr(seq, &#39;next&#39;):  
        seq = iter(seq)
    while True: 
        x = list(take(seq, size))
        if x:
            yield x
        else:
            break
</pre></div>


<p>对iterator中的key进行uniq：   </p>
<div class="highlight"><pre><span class="nx">def</span> <span class="nx">uniq</span><span class="p">(</span><span class="nx">seq</span><span class="p">,</span> <span class="nx">key</span><span class="o">=</span><span class="nx">None</span><span class="p">)</span><span class="o">:</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Removes duplicate elements from a list while preserving the order of the rest.</span>

<span class="s2">        &gt;&gt;&gt; uniq(</span><span class="cp">[</span><span class="mi">9</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="cp">]</span><span class="s2">)</span>
<span class="s2">        </span><span class="cp">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="cp">]</span><span class="s2"></span>

<span class="s2">    The value of the optional `key` parameter should be a function that</span>
<span class="s2">    takes a single argument and returns a key to test the uniqueness.</span>

<span class="s2">        &gt;&gt;&gt; uniq(</span><span class="cp">[</span><span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="cp">]</span><span class="s2">, key=lambda s: s.lower())</span>
<span class="s2">        </span><span class="cp">[</span><span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="cp">]</span><span class="s2"></span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span> <span class="nx">or</span> <span class="p">(</span><span class="nx">lambda</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">)</span>
    <span class="nx">seen</span> <span class="o">=</span> <span class="nx">set</span><span class="p">()</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="cp">[]</span>
    <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">seq</span><span class="o">:</span>
        <span class="nx">k</span> <span class="o">=</span> <span class="nx">key</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">seen</span><span class="o">:</span>
            <span class="k">continue</span>
        <span class="nx">seen</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">result</span>
</pre></div>


<p>按照iter来显示执行进度，for example：   </p>
<p>0.0% (0/4) [&gt;                                             ] ETA --:--:--process 1 <br />
 25.0% (1/4) [===========&gt;                                ] ETA 00:00:00process 2 <br />
 50.0% (2/4) [======================&gt;                     ] ETA 00:00:00process 3 <br />
 75.0% (3/4) [=================================&gt;          ] ETA 00:00:00process 4 <br />
100.0% (4/4) [============================================]     00:00:00</p>
<p>中间是一些dict和一些字符串、数字的处理函数，这里不研究与介绍；   </p>
<p>class Profile，是一个记录func执行时间的函数：   </p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Profile</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Profiles `func` and returns a tuple containing its output</span>
<span class="sd">    and a string with human-readable profiling information.</span>

<span class="sd">        &gt;&gt;&gt; import time</span>
<span class="sd">        &gt;&gt;&gt; out, inf = profile(time.sleep)(.001)</span>
<span class="sd">        &gt;&gt;&gt; out</span>
<span class="sd">        &gt;&gt;&gt; inf[:10].strip()</span>
<span class="sd">        &#39;took 0.0&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="c">##, **kw):   kw unused</span>
        <span class="kn">import</span> <span class="nn">hotshot</span><span class="o">,</span> <span class="nn">hotshot.stats</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">tempfile</span> <span class="c">##, time already imported</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">prof</span> <span class="o">=</span> <span class="n">hotshot</span><span class="o">.</span><span class="n">Profile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">stime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">runcall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">stime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">stime</span>
        <span class="n">prof</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="kn">import</span> <span class="nn">cStringIO</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">hotshot</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">out</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">strip_dirs</span><span class="p">()</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">,</span> <span class="s">&#39;calls&#39;</span><span class="p">)</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">print_callers</span><span class="p">()</span>

        <span class="n">x</span> <span class="o">=</span>  <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">took &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stime</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; seconds</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="n">out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

        <span class="c"># remove the tempfile</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">x</span>
</pre></div>


<p>继承了threadlocal、对threadlocal进行了dict类似的封装,threadlocal的出现意义，可以参照<a href="http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001386832845200f6513494f0c64bd882f25818a0281e80000">这里</a>：   </p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">ThreadedDict</span><span class="p">(</span><span class="n">threadlocal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Thread local storage.</span>

<span class="sd">        &gt;&gt;&gt; d = ThreadedDict()</span>
<span class="sd">        &gt;&gt;&gt; d.x = 1</span>
<span class="sd">        &gt;&gt;&gt; d.x</span>
<span class="sd">        1</span>
<span class="sd">        &gt;&gt;&gt; import threading</span>
<span class="sd">        &gt;&gt;&gt; def f(): d.x = 2</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; t = threading.Thread(target=f)</span>
<span class="sd">        &gt;&gt;&gt; t.start()</span>
<span class="sd">        &gt;&gt;&gt; t.join()</span>
<span class="sd">        &gt;&gt;&gt; d.x</span>
<span class="sd">        1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_instances</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ThreadedDict</span><span class="o">.</span><span class="n">_instances</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ThreadedDict</span><span class="o">.</span><span class="n">_instances</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_all</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Clears all ThreadedDict instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ThreadedDict</span><span class="o">.</span><span class="n">_instances</span><span class="p">):</span>
            <span class="n">t</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">clear_all</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">clear_all</span><span class="p">)</span>

    <span class="c"># Define all these methods to more or less fully emulate dict -- attribute access</span>
    <span class="c"># is built into threading.local.</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span>

    <span class="n">has_key</span> <span class="o">=</span> <span class="n">__contains__</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">iterkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()</span>

    <span class="nb">iter</span> <span class="o">=</span> <span class="n">iterkeys</span>

    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">popitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;ThreadedDict </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span>

    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>
</pre></div>


<p>对send_email进行了封装，但对于中文有几个点事需要去避免的，在我自己的lib实现中已经改正了:    </p>
<div class="highlight"><pre>def sendmail(from_address, to_address, subject, message, headers=None, **kw):
&quot;&quot;&quot;
Sends the email message `message` with mail and envelope headers
for from `from_address_` to `to_address` with `subject`. 
Additional email headers can be specified with the dictionary 
`headers.

Optionally cc, bcc and attachments can be specified as keyword arguments.
Attachments must be an iterable and each attachment can be either a 
filename or a file object or a dictionary with filename, content and 
optionally content_type keys.

If `web.config.smtp_server` is set, it will send the message
to that SMTP server. Otherwise it will look for 
`/usr/sbin/sendmail`, the typical location for the sendmail-style
binary. To use sendmail from a different path, set `web.config.sendmail_path`.
&quot;&quot;&quot;
attachments = kw.pop(&quot;attachments&quot;, [])
mail = _EmailMessage(from_address, to_address, subject, message, headers, **kw)

for a in attachments:
    if isinstance(a, dict):
        mail.attach(a[&#39;filename&#39;], a[&#39;content&#39;], a.get(&#39;content_type&#39;))
    elif hasattr(a, &#39;read&#39;): # file
        filename = os.path.basename(getattr(a, &quot;name&quot;, &quot;&quot;))
        content_type = getattr(a, &#39;content_type&#39;, None)
        mail.attach(filename, a.read(), content_type)
    elif isinstance(a, basestring):
        f = open(a, &#39;rb&#39;)
        content = f.read()
        f.close()
        filename = os.path.basename(a)
        mail.attach(filename, content, None)
    else:
        raise ValueError, &quot;Invalid attachment: %s&quot; % repr(a)

mail.send()

class _EmailMessage:
def __init__(self, from_address, to_address, subject, message, headers=None, **kw):
    def listify(x):
        if not isinstance(x, list):
            return [safestr(x)]
        else:
            return [safestr(a) for a in x]

    subject = safestr(subject)
    message = safestr(message)

    from_address = safestr(from_address)
    to_address = listify(to_address)    
    cc = listify(kw.get(&#39;cc&#39;, []))
    bcc = listify(kw.get(&#39;bcc&#39;, []))
    recipients = to_address + cc + bcc

    import email.Utils
    self.from_address = email.Utils.parseaddr(from_address)[1]
    self.recipients = [email.Utils.parseaddr(r)[1] for r in recipients]

    self.headers = dictadd({
      &#39;From&#39;: from_address,
      &#39;To&#39;: &quot;, &quot;.join(to_address),
      &#39;Subject&#39;: subject
    }, headers or {})

    if cc:
        self.headers[&#39;Cc&#39;] = &quot;, &quot;.join(cc)

    self.message = self.new_message()
    self.message.add_header(&quot;Content-Transfer-Encoding&quot;, &quot;7bit&quot;)
    self.message.add_header(&quot;Content-Disposition&quot;, &quot;inline&quot;)
    self.message.add_header(&quot;MIME-Version&quot;, &quot;1.0&quot;)
    self.message.set_payload(message, &#39;utf-8&#39;)
    self.multipart = False

def new_message(self):
    from email.Message import Message
    return Message()

def attach(self, filename, content, content_type=None):
    if not self.multipart:
        msg = self.new_message()
        msg.add_header(&quot;Content-Type&quot;, &quot;multipart/mixed&quot;)
        msg.attach(self.message)
        self.message = msg
        self.multipart = True

    import mimetypes
    try:
        from email import encoders
    except:
        from email import Encoders as encoders

    content_type = content_type or mimetypes.guess_type(filename)[0] or &quot;applcation/octet-stream&quot;

    msg = self.new_message()
    msg.set_payload(content)
    msg.add_header(&#39;Content-Type&#39;, content_type)
    msg.add_header(&#39;Content-Disposition&#39;, &#39;attachment&#39;, filename=filename)

    if not content_type.startswith(&quot;text/&quot;):
        encoders.encode_base64(msg)

    self.message.attach(msg)

def prepare_message(self):
    for k, v in self.headers.iteritems():
        if k.lower() == &quot;content-type&quot;:
            self.message.set_type(v)
        else:
            self.message.add_header(k, v)

    self.headers = {}

def send(self):
    try:
        import webapi
    except ImportError:
        webapi = Storage(config=Storage())

    self.prepare_message()
    message_text = self.message.as_string()

    if webapi.config.get(&#39;smtp_server&#39;):
        server = webapi.config.get(&#39;smtp_server&#39;)
        port = webapi.config.get(&#39;smtp_port&#39;, 0)
        username = webapi.config.get(&#39;smtp_username&#39;) 
        password = webapi.config.get(&#39;smtp_password&#39;)
        debug_level = webapi.config.get(&#39;smtp_debuglevel&#39;, None)
        starttls = webapi.config.get(&#39;smtp_starttls&#39;, False)

        import smtplib
        smtpserver = smtplib.SMTP(server, port)

        if debug_level:
            smtpserver.set_debuglevel(debug_level)

        if starttls:
            smtpserver.ehlo()
            smtpserver.starttls()
            smtpserver.ehlo()

        if username and password:
            smtpserver.login(username, password)

        smtpserver.sendmail(self.from_address, self.recipients, message_text)
        smtpserver.quit()
    elif webapi.config.get(&#39;email_engine&#39;) == &#39;aws&#39;:
        import boto.ses
        c = boto.ses.SESConnection(
          aws_access_key_id=webapi.config.get(&#39;aws_access_key_id&#39;),
          aws_secret_access_key=web.api.config.get(&#39;aws_secret_access_key&#39;))
        c.send_raw_email(self.from_address, message_text, self.recipients)
    else:
        sendmail = webapi.config.get(&#39;sendmail_path&#39;, &#39;/usr/sbin/sendmail&#39;)

        assert not self.from_address.startswith(&#39;-&#39;), &#39;security&#39;
        for r in self.recipients:
            assert not r.startswith(&#39;-&#39;), &#39;security&#39;

        cmd = [sendmail, &#39;-f&#39;, self.from_address] + self.recipients

        if subprocess:
            p = subprocess.Popen(cmd, stdin=subprocess.PIPE)
            p.stdin.write(message_text)
            p.stdin.close()
            p.wait()
        else:
            i, o = os.popen2(cmd)
            i.write(message)
            i.close()
            o.close()
            del i, o

def __repr__(self):
    return &quot;&lt;EmailMessage&gt;&quot;

def __str__(self):
    return self.message.as_string()
</pre></div>


<h4><strong>1.3.2 webapi.py</strong><span id="1.3.2"></span></h4>
<p>webapi是对<a href="http://baike.baidu.com/link?url=Ba7KSEpRiPngmAHfLoOJyQ8b_7OBdLeqD6IxwLPBqfT24JqqobNkflXcfZB69rZ2vGHmUZ0hvJZ-ypROoPlIcq">WSGI</a>的封装，是一些对Http协议的一些异常(错误码)封装。</p>
<h4><strong>1.3.3 application.py</strong><span id="1.3.3"></span></h4>
<p><a href="https://www.zhihu.com/question/19998865">cgi&amp;wsgi的区别</a>
主要是load我们的processor，然后调用WSGI进行listen。</p>
<div class="highlight"><pre>* *init_mapping:* 获取用户的mapping
* *add_processor:* 增加一个processor，这个processor的参数是一个handler  
* *request:* 根据传入的构造request的参数构造出env，然后调用wsgifunc处理。
</pre></div>


<h4><strong>1.3.4 wsgiserver</strong><span id="1.3.4"></span></h4>
<p><a href="http://www.cherrypy.org/">CherryPy</a>实现的一个httpserver，这个正是我所想看的。
当初写rpc的时候，想加httpserver的时候，就想自己写一个。不过没时间动手。 <br />
既然现在已经发现有了一个，那就学习学习，看看人家是怎么写的吧，有兴趣，自己再动手写一个。 </p>
<p><strong>func read_headers</strong>：<br />
读http协议头并解析其中的key value到一个dict中去，返回dict。 
NOTE：窥探第一个func，就了解到了cherrypy的错误处理是使用异常的，不过用异常处理错误还是蛮清晰的嘛。   </p>
<div class="highlight"><pre><span class="nx">def</span> <span class="nx">read_headers</span><span class="p">(</span><span class="nx">rfile</span><span class="p">,</span> <span class="nx">hdict</span><span class="o">=</span><span class="nx">None</span><span class="p">)</span><span class="o">:</span>
    <span class="s2">&quot;&quot;&quot;Read headers from the given stream into the given header dict.</span>

<span class="s2">    If hdict is None, a new header dict is created. Returns the populated</span>
<span class="s2">    header dict.</span>

<span class="s2">    Headers which are repeated are folded together using a comma if their</span>
<span class="s2">    specification so dictates.</span>

<span class="s2">    This function raises ValueError when the read bytes violate the HTTP spec.</span>
<span class="s2">    You should probably return &quot;</span><span class="mi">400</span> <span class="nx">Bad</span> <span class="nx">Request</span><span class="s2">&quot; if this happens.</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nx">hdict</span> <span class="nx">is</span> <span class="nx">None</span><span class="o">:</span>
        <span class="nx">hdict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">while</span> <span class="nx">True</span><span class="o">:</span>
        <span class="nx">line</span> <span class="o">=</span> <span class="nx">rfile</span><span class="p">.</span><span class="nx">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">not</span> <span class="nx">line</span><span class="o">:</span>
            <span class="err">#</span> <span class="nx">No</span> <span class="nx">more</span> <span class="nx">data</span><span class="o">--</span><span class="nx">illegal</span> <span class="nx">end</span> <span class="nx">of</span> <span class="nx">headers</span>
            <span class="nx">raise</span> <span class="nx">ValueError</span><span class="p">(</span><span class="s2">&quot;Illegal end of headers.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nx">line</span> <span class="o">==</span> <span class="nx">CRLF</span><span class="o">:</span>
            <span class="err">#</span> <span class="nx">Normal</span> <span class="nx">end</span> <span class="nx">of</span> <span class="nx">headers</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="nx">not</span> <span class="nx">line</span><span class="p">.</span><span class="nx">endswith</span><span class="p">(</span><span class="nx">CRLF</span><span class="p">)</span><span class="o">:</span>
            <span class="nx">raise</span> <span class="nx">ValueError</span><span class="p">(</span><span class="s2">&quot;HTTP requires CRLF terminators&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nx">line</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span> <span class="k">in</span> <span class="s1">&#39; \t&#39;</span><span class="o">:</span>
            <span class="err">#</span> <span class="nx">It</span><span class="err">&#39;</span><span class="nx">s</span> <span class="nx">a</span> <span class="nx">continuation</span> <span class="nx">line</span><span class="p">.</span>
            <span class="nx">v</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="o">:</span>
            <span class="k">try</span><span class="o">:</span>
                <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="nx">except</span> <span class="nx">ValueError</span><span class="o">:</span>
                <span class="nx">raise</span> <span class="nx">ValueError</span><span class="p">(</span><span class="s2">&quot;Illegal header line.&quot;</span><span class="p">)</span>
            <span class="err">#</span> <span class="nx">TODO</span><span class="o">:</span> <span class="nx">what</span> <span class="nx">about</span> <span class="nx">TE</span> <span class="nx">and</span> <span class="nx">WWW</span><span class="o">-</span><span class="nx">Authenticate</span><span class="o">?</span>
            <span class="nx">k</span> <span class="o">=</span> <span class="nx">k</span><span class="p">.</span><span class="nx">strip</span><span class="p">().</span><span class="nx">title</span><span class="p">()</span>
            <span class="nx">v</span> <span class="o">=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">strip</span><span class="p">()</span>
            <span class="nx">hname</span> <span class="o">=</span> <span class="nx">k</span>

        <span class="k">if</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">comma_separated_headers</span><span class="o">:</span>
            <span class="nx">existing</span> <span class="o">=</span> <span class="nx">hdict</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">hname</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">existing</span><span class="o">:</span>
                <span class="nx">v</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="p">.</span><span class="nx">join</span><span class="p">((</span><span class="nx">existing</span><span class="p">,</span> <span class="nx">v</span><span class="p">))</span>
        <span class="nx">hdict</span><span class="cp">[</span><span class="nx">hname</span><span class="cp">]</span> <span class="o">=</span> <span class="nx">v</span>

    <span class="k">return</span> <span class="nx">hdict</span>
</pre></div>


<p><strong>class SizeCheckWrapper &amp;&amp; class KnownLengthRFile</strong>：
At first，作者太有意思了，<strong>"Shamelessly stolen from StringIO"</strong>..... 0.-! 以后我也要这么谦虚呀。 
这两个类对file对象的又一层包装(感觉有些函数和class可以在抽象、复用一下)。</p>
<div class="highlight"><pre>* SizeCheckWrapper限制所读的内容不能大于某一个值，超过会raise exception。  
* 相比而言，KnownLengthRFile就比较优雅了，严格限制所读的最大内容量，就算你指定了超过量也不能多读。

class SizeCheckWrapper(object):
    &quot;&quot;&quot;Wraps a file-like object, raising MaxSizeExceeded if too large.&quot;&quot;&quot;

    def __init__(self, rfile, maxlen):
        self.rfile = rfile
        self.maxlen = maxlen
        self.bytes_read = 0

    def _check_length(self):
        if self.maxlen and self.bytes_read &gt; self.maxlen:
            raise MaxSizeExceeded()

    def read(self, size=None):
        data = self.rfile.read(size)
        self.bytes_read += len(data)
        self._check_length()
        return data

    def readline(self, size=None):
        if size is not None:
            data = self.rfile.readline(size)
            self.bytes_read += len(data)
            self._check_length()
            return data

        # User didn&#39;t specify a size ...
        # We read the line in chunks to make sure it&#39;s not a 100MB line !
        res = []
        while True:
            data = self.rfile.readline(256)
            self.bytes_read += len(data)
            self._check_length()
            res.append(data)
            # See http://www.cherrypy.org/ticket/421
            if len(data) &lt; 256 or data[-1:] == &quot;\n&quot;:
                return &#39;&#39;.join(res)

    def readlines(self, sizehint=0):
        # Shamelessly stolen from StringIO
        total = 0
        lines = []
        line = self.readline()
        while line:
            lines.append(line)
            total += len(line)
            if 0 &lt; sizehint &lt;= total:
                break
            line = self.readline()
        return lines

    def close(self):
        self.rfile.close()

    def __iter__(self):
        return self

    def next(self):
        data = self.rfile.next()
        self.bytes_read += len(data)
        self._check_length()
        return data
</pre></div>


<p><strong> class HttpRequest</strong>:<br />
看这段代码，建议你还是curl一段header头作为example结合来看：   </p>
<div class="highlight"><pre><span class="nt">curl</span> <span class="nt">-I</span> <span class="s2">&quot;http://www.baidu.com/link?url=2rHsQrQ4BBEi1IEODX82c7kggs3EBIxd45yV3UlcEaUJBr1eLo9RDgq0LfxpNT5kAoMyp6rpecfsOqgUhStyhqcO7WIOXthdAIFxPWurM-W&quot;</span> <span class="nt">-v</span>

<span class="o">*</span> <span class="nt">Hostname</span> <span class="nt">was</span> <span class="nt">NOT</span> <span class="nt">found</span> <span class="nt">in</span> <span class="nt">DNS</span> <span class="nt">cache</span>
<span class="o">*</span>   <span class="nt">Trying</span> <span class="nt">220</span><span class="nc">.181.112.244</span><span class="o">...</span>
<span class="o">*</span> <span class="nt">Connected</span> <span class="nt">to</span> <span class="nt">www</span><span class="nc">.baidu.com</span> <span class="o">(</span><span class="nt">220</span><span class="nc">.181.112.244</span><span class="o">)</span> <span class="nt">port</span> <span class="nt">80</span> <span class="o">(</span><span class="nf">#0</span><span class="o">)</span>
<span class="o">&gt;</span> <span class="nt">HEAD</span> <span class="o">/</span><span class="nt">link</span><span class="o">?</span><span class="nt">url</span><span class="o">=</span><span class="nt">2rHsQrQ4BBEi1IEODX82c7kggs3EBIxd45yV3UlcEaUJBr1eLo9RDgq0LfxpNT5kAoMyp6rpecfsOqgUhStyhqcO7WIOXthdAIFxPWurM-W</span> <span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="nc">.1</span>
<span class="o">&gt;</span> <span class="nt">User-Agent</span><span class="o">:</span> <span class="nt">curl</span><span class="o">/</span><span class="nt">7</span><span class="nc">.36.0</span>
<span class="o">&gt;</span> <span class="nt">Host</span><span class="o">:</span> <span class="nt">www</span><span class="nc">.baidu.com</span>
<span class="o">&gt;</span> <span class="nt">Accept</span><span class="o">:</span> <span class="o">*/*</span>
<span class="o">&gt;</span> 
<span class="o">&lt;</span> <span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="nc">.1</span> <span class="nt">302</span> <span class="nt">Moved</span> <span class="nt">Temporarily</span>
<span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="nc">.1</span> <span class="nt">302</span> <span class="nt">Moved</span> <span class="nt">Temporarily</span>
<span class="o">&lt;</span> <span class="nt">Date</span><span class="o">:</span> <span class="nt">Thu</span><span class="o">,</span> <span class="nt">17</span> <span class="nt">Dec</span> <span class="nt">2015</span> <span class="nt">14</span><span class="nd">:10:07</span> <span class="nt">GMT</span>
<span class="nt">Date</span><span class="o">:</span> <span class="nt">Thu</span><span class="o">,</span> <span class="nt">17</span> <span class="nt">Dec</span> <span class="nt">2015</span> <span class="nt">14</span><span class="nd">:10:07</span> <span class="nt">GMT</span>
<span class="o">&lt;</span> <span class="nt">Content-Type</span><span class="o">:</span> <span class="nt">text</span><span class="o">/</span><span class="nt">html</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">utf8</span>
<span class="nt">Content-Type</span><span class="o">:</span> <span class="nt">text</span><span class="o">/</span><span class="nt">html</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">utf8</span>
<span class="o">&lt;</span> <span class="nt">Content-Length</span><span class="o">:</span> <span class="nt">215</span>
<span class="nt">Content-Length</span><span class="o">:</span> <span class="nt">215</span>
<span class="o">&lt;</span> <span class="nt">Connection</span><span class="o">:</span> <span class="nt">Keep-Alive</span>
<span class="nt">Connection</span><span class="o">:</span> <span class="nt">Keep-Alive</span>
<span class="o">&lt;</span> <span class="nt">Location</span><span class="o">:</span> <span class="nt">http</span><span class="o">://</span><span class="nt">baike</span><span class="nc">.baidu.com</span><span class="o">/</span><span class="nt">link</span><span class="o">?</span><span class="nt">url</span><span class="o">=</span><span class="nt">2rHsQrQ4BBEi1IEODX82c7kggs3EBIxd45yV3UlcEaUJBr1eLo9RDgq0LfxpNT5kAoMyp6rpecfsOqgUhStyhqcO7WIOXthdAIFxPWurM-W</span>
<span class="nt">Location</span><span class="o">:</span> <span class="nt">http</span><span class="o">://</span><span class="nt">baike</span><span class="nc">.baidu.com</span><span class="o">/</span><span class="nt">link</span><span class="o">?</span><span class="nt">url</span><span class="o">=</span><span class="nt">2rHsQrQ4BBEi1IEODX82c7kggs3EBIxd45yV3UlcEaUJBr1eLo9RDgq0LfxpNT5kAoMyp6rpecfsOqgUhStyhqcO7WIOXthdAIFxPWurM-W</span>
<span class="o">*</span> <span class="nt">Server</span> <span class="nt">BWS</span><span class="o">/</span><span class="nt">1</span><span class="nc">.1</span> <span class="nt">is</span> <span class="nt">not</span> <span class="nt">blacklisted</span>
<span class="o">&lt;</span> <span class="nt">Server</span><span class="o">:</span> <span class="nt">BWS</span><span class="o">/</span><span class="nt">1</span><span class="nc">.1</span>
<span class="nt">Server</span><span class="o">:</span> <span class="nt">BWS</span><span class="o">/</span><span class="nt">1</span><span class="nc">.1</span>
<span class="o">&lt;</span> <span class="nt">X-UA-Compatible</span><span class="o">:</span> <span class="nt">IE</span><span class="o">=</span><span class="nt">Edge</span><span class="o">,</span><span class="nt">chrome</span><span class="o">=</span><span class="nt">1</span>
<span class="nt">X-UA-Compatible</span><span class="o">:</span> <span class="nt">IE</span><span class="o">=</span><span class="nt">Edge</span><span class="o">,</span><span class="nt">chrome</span><span class="o">=</span><span class="nt">1</span>
<span class="o">&lt;</span> <span class="nt">Pragma</span><span class="o">:</span> <span class="nt">no-cache</span>
<span class="nt">Pragma</span><span class="o">:</span> <span class="nt">no-cache</span>
<span class="o">&lt;</span> <span class="nt">Expires</span><span class="o">:</span> <span class="nt">Fri</span><span class="o">,</span> <span class="nt">01</span> <span class="nt">Jan</span> <span class="nt">1990</span> <span class="nt">00</span><span class="nd">:00:00</span> <span class="nt">GMT</span>
<span class="nt">Expires</span><span class="o">:</span> <span class="nt">Fri</span><span class="o">,</span> <span class="nt">01</span> <span class="nt">Jan</span> <span class="nt">1990</span> <span class="nt">00</span><span class="nd">:00:00</span> <span class="nt">GMT</span>
<span class="o">&lt;</span> <span class="nt">Cache-Control</span><span class="o">:</span> <span class="nt">no-cache</span><span class="o">,</span> <span class="nt">must-revalidate</span>
<span class="nt">Cache-Control</span><span class="o">:</span> <span class="nt">no-cache</span><span class="o">,</span> <span class="nt">must-revalidate</span>
<span class="o">&lt;</span> <span class="nt">X-XSS-Protection</span><span class="o">:</span> <span class="nt">1</span><span class="o">;</span><span class="nt">mode</span><span class="o">=</span><span class="nt">block</span>
<span class="nt">X-XSS-Protection</span><span class="o">:</span> <span class="nt">1</span><span class="o">;</span><span class="nt">mode</span><span class="o">=</span><span class="nt">block</span>
<span class="o">&lt;</span> <span class="nt">BDPAGETYPE</span><span class="o">:</span> <span class="nt">3</span>
<span class="nt">BDPAGETYPE</span><span class="o">:</span> <span class="nt">3</span>
<span class="o">&lt;</span> <span class="nt">Set-Cookie</span><span class="o">:</span> <span class="nt">BDSVRTM</span><span class="o">=</span><span class="nt">0</span><span class="o">;</span> <span class="nt">path</span><span class="o">=/</span>
<span class="nt">Set-Cookie</span><span class="o">:</span> <span class="nt">BDSVRTM</span><span class="o">=</span><span class="nt">0</span><span class="o">;</span> <span class="nt">path</span><span class="o">=/</span>
</pre></div>


<p>然后看你的request header:  </p>
<p>在看这个Request的实现逻辑，很清晰：</p>
<div class="highlight"><pre><span class="o">*</span> <span class="nt">_read_request_line</span><span class="nd">:_</span> <span class="err">取第一行解析</span><span class="nt">Method</span> <span class="nt">path</span> <span class="nt">protocol</span><span class="err">\</span><span class="nt">r</span><span class="err">\</span><span class="nt">n</span>
<span class="o">*</span> <span class="nt">_read_request_headers</span><span class="nd">:_</span> <span class="err">取到结束，存到</span><span class="nt">inheaders</span><span class="err">内</span>
<span class="o">*</span> <span class="nt">_parse_request_uri</span><span class="nd">:_</span> <span class="err">其中</span><span class="nt">path</span><span class="err">中可能夹杂着</span><span class="nt">auth</span><span class="err">的部分，所以需要对</span><span class="nt">path</span><span class="err">也解析一下</span>
<span class="o">*</span> <span class="nt">_simple_response</span><span class="nd">:_</span> <span class="err">对于有些非法的请求的简单</span><span class="nt">response</span>
<span class="o">*</span> <span class="nt">_send_headers</span><span class="nd">:_</span> <span class="err">根据</span><span class="nt">request</span><span class="err">和</span><span class="nt">server</span><span class="err">的一些特殊性，返回</span><span class="nt">outheaders</span>
<span class="o">*</span> <span class="nt">_respond</span><span class="nd">:_</span> <span class="err">调用</span><span class="nt">server</span><span class="err">的</span><span class="o">**</span><span class="nt">gateway</span><span class="o">**(</span><span class="nt">WSGI</span><span class="o">)</span><span class="err">返回数据，并返回</span><span class="nt">headers</span>
<span class="o">*</span> <span class="nt">_write</span><span class="nd">:_</span> <span class="nt">1</span><span class="o">.</span> <span class="err">返回</span><span class="nt">outheaders</span> <span class="nt">2</span><span class="o">.</span> <span class="err">根据用户要求的返回数据方式</span><span class="o">(</span><span class="nt">if</span> <span class="nt">chunk</span><span class="o">?)</span><span class="err">，返回数据。</span><span class="nt">chunk</span><span class="err">返回需要单独带个</span><span class="nt">16</span><span class="err">进制</span><span class="o">+</span><span class="err">\</span><span class="nt">r</span><span class="err">\</span><span class="nt">n</span><span class="err">的数据大小</span>

<span class="nt">class</span> <span class="nt">HTTPRequest</span><span class="o">(</span><span class="nt">object</span><span class="o">):</span>
    <span class="s2">&quot;&quot;&quot;An HTTP Request (and response).</span>

<span class="s2">    A single HTTP connection may consist of multiple request/response pairs.</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="nt">server</span> <span class="o">=</span> <span class="nt">None</span>
    <span class="s2">&quot;&quot;&quot;The HTTPServer object which is receiving this request.&quot;&quot;&quot;</span>

    <span class="nt">conn</span> <span class="o">=</span> <span class="nt">None</span>
    <span class="s2">&quot;&quot;&quot;The HTTPConnection object on which this request connected.&quot;&quot;&quot;</span>

    <span class="nt">inheaders</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="s2">&quot;&quot;&quot;A dict of request headers.&quot;&quot;&quot;</span>

    <span class="nt">outheaders</span> <span class="o">=</span> <span class="cp">[]</span>
    <span class="s2">&quot;&quot;&quot;A list of header tuples to write in the response.&quot;&quot;&quot;</span>

    <span class="nt">ready</span> <span class="o">=</span> <span class="nt">False</span>
    <span class="s2">&quot;&quot;&quot;When True, the request has been parsed and is ready to begin generating</span>
<span class="s2">    the response. When False, signals the calling Connection that the response</span>
<span class="s2">    should not be generated and the connection should close.&quot;&quot;&quot;</span>

    <span class="nt">close_connection</span> <span class="o">=</span> <span class="nt">False</span>
    <span class="s2">&quot;&quot;&quot;Signals the calling Connection that the request should close. This does</span>
<span class="s2">    not imply an error! The client and/or server may each request that the</span>
<span class="s2">    connection be closed.&quot;&quot;&quot;</span>

    <span class="nt">chunked_write</span> <span class="o">=</span> <span class="nt">False</span>
    <span class="s2">&quot;&quot;&quot;If True, output will be encoded with the &quot;</span><span class="nt">chunked</span><span class="s2">&quot; transfer-coding.</span>

<span class="s2">    This value is set automatically inside send_headers.&quot;&quot;&quot;</span>

    <span class="nt">def</span> <span class="nt">__init__</span><span class="o">(</span><span class="nt">self</span><span class="o">,</span> <span class="nt">server</span><span class="o">,</span> <span class="nt">conn</span><span class="o">):</span>
        <span class="nt">self</span><span class="nc">.server</span><span class="o">=</span> <span class="nt">server</span>
        <span class="nt">self</span><span class="nc">.conn</span> <span class="o">=</span> <span class="nt">conn</span>

        <span class="nt">self</span><span class="nc">.ready</span> <span class="o">=</span> <span class="nt">False</span>
        <span class="nt">self</span><span class="nc">.started_request</span> <span class="o">=</span> <span class="nt">False</span>
        <span class="nt">self</span><span class="nc">.scheme</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="nt">if</span> <span class="nt">self</span><span class="nc">.server.ssl_adapter</span> <span class="nt">is</span> <span class="nt">not</span> <span class="nt">None</span><span class="o">:</span>
            <span class="nt">self</span><span class="nc">.scheme</span> <span class="o">=</span> <span class="s2">&quot;https&quot;</span>
        <span class="err">#</span> <span class="nt">Use</span> <span class="nt">the</span> <span class="nt">lowest-common</span> <span class="nt">protocol</span> <span class="nt">in</span> <span class="nt">case</span> <span class="nt">read_request_line</span> <span class="nt">errors</span><span class="o">.</span>
        <span class="nt">self</span><span class="nc">.response_protocol</span> <span class="o">=</span> <span class="s1">&#39;HTTP/1.0&#39;</span>
        <span class="nt">self</span><span class="nc">.inheaders</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nt">self</span><span class="nc">.status</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="nt">self</span><span class="nc">.outheaders</span> <span class="o">=</span> <span class="cp">[]</span>
        <span class="nt">self</span><span class="nc">.sent_headers</span> <span class="o">=</span> <span class="nt">False</span>
        <span class="nt">self</span><span class="nc">.close_connection</span> <span class="o">=</span> <span class="nt">self</span><span class="nc">.__class__.close_connection</span>
        <span class="nt">self</span><span class="nc">.chunked_read</span> <span class="o">=</span> <span class="nt">False</span>
        <span class="nt">self</span><span class="nc">.chunked_write</span> <span class="o">=</span> <span class="nt">self</span><span class="nc">.__class__.chunked_write</span>

    <span class="nt">def</span> <span class="nt">parse_request</span><span class="o">(</span><span class="nt">self</span><span class="o">):</span>
        <span class="s2">&quot;&quot;&quot;Parse the next HTTP request start-line and message-headers.&quot;&quot;&quot;</span>
        <span class="nt">self</span><span class="nc">.rfile</span> <span class="o">=</span> <span class="nt">SizeCheckWrapper</span><span class="o">(</span><span class="nt">self</span><span class="nc">.conn.rfile</span><span class="o">,</span>
                                      <span class="nt">self</span><span class="nc">.server.max_request_header_size</span><span class="o">)</span>
        <span class="nt">try</span><span class="o">:</span>
            <span class="nt">self</span><span class="nc">.read_request_line</span><span class="o">()</span>
        <span class="nt">except</span> <span class="nt">MaxSizeExceeded</span><span class="o">:</span>
            <span class="nt">self</span><span class="nc">.simple_response</span><span class="o">(</span><span class="s2">&quot;414 Request-URI Too Long&quot;</span><span class="o">,</span>
                <span class="s2">&quot;The Request-URI sent with the request exceeds the maximum &quot;</span>
                <span class="s2">&quot;allowed bytes.&quot;</span><span class="o">)</span>
            <span class="nt">return</span>

        <span class="nt">try</span><span class="o">:</span>
            <span class="nt">success</span> <span class="o">=</span> <span class="nt">self</span><span class="nc">.read_request_headers</span><span class="o">()</span>
        <span class="nt">except</span> <span class="nt">MaxSizeExceeded</span><span class="o">:</span>
            <span class="nt">self</span><span class="nc">.simple_response</span><span class="o">(</span><span class="s2">&quot;413 Request Entity Too Large&quot;</span><span class="o">,</span>
                <span class="s2">&quot;The headers sent with the request exceed the maximum &quot;</span>
                <span class="s2">&quot;allowed bytes.&quot;</span><span class="o">)</span>
            <span class="nt">return</span>
        <span class="nt">else</span><span class="o">:</span>
            <span class="nt">if</span> <span class="nt">not</span> <span class="nt">success</span><span class="o">:</span>
                <span class="nt">return</span>

        <span class="nt">self</span><span class="nc">.ready</span> <span class="o">=</span> <span class="nt">True</span>

    <span class="nt">def</span> <span class="nt">read_request_line</span><span class="o">(</span><span class="nt">self</span><span class="o">):</span>
        <span class="err">#</span> <span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="nc">.1</span> <span class="nt">connections</span> <span class="nt">are</span> <span class="nt">persistent</span> <span class="nt">by</span> <span class="nt">default</span><span class="o">.</span> <span class="nt">If</span> <span class="nt">a</span> <span class="nt">client</span>
        <span class="err">#</span> <span class="nt">requests</span> <span class="nt">a</span> <span class="nt">page</span><span class="o">,</span> <span class="nt">then</span> <span class="nt">idles</span> <span class="o">(</span><span class="nt">leaves</span> <span class="nt">the</span> <span class="nt">connection</span> <span class="nt">open</span><span class="o">),</span>
        <span class="err">#</span> <span class="nt">then</span> <span class="nt">rfile</span><span class="nc">.readline</span><span class="o">()</span> <span class="nt">will</span> <span class="nt">raise</span> <span class="nt">socket</span><span class="nc">.error</span><span class="o">(</span><span class="s2">&quot;timed out&quot;</span><span class="o">).</span>
        <span class="err">#</span> <span class="nt">Note</span> <span class="nt">that</span> <span class="nt">it</span> <span class="nt">does</span> <span class="nt">this</span> <span class="nt">based</span> <span class="nt">on</span> <span class="nt">the</span> <span class="nt">value</span> <span class="nt">given</span> <span class="nt">to</span> <span class="nt">settimeout</span><span class="o">(),</span>
        <span class="err">#</span> <span class="nt">and</span> <span class="nt">doesn</span><span class="s1">&#39;t need the client to request or acknowledge the close</span>
<span class="s1">        # (although your TCP stack might suffer for it: cf Apache&#39;</span><span class="nt">s</span> <span class="nt">history</span>
        <span class="err">#</span> <span class="nt">with</span> <span class="nt">FIN_WAIT_2</span><span class="o">).</span>
        <span class="nt">request_line</span> <span class="o">=</span> <span class="nt">self</span><span class="nc">.rfile.readline</span><span class="o">()</span>

        <span class="err">#</span> <span class="nt">Set</span> <span class="nt">started_request</span> <span class="nt">to</span> <span class="nt">True</span> <span class="nt">so</span> <span class="nt">communicate</span><span class="o">()</span> <span class="nt">knows</span> <span class="nt">to</span> <span class="nt">send</span> <span class="nt">408</span>
        <span class="err">#</span> <span class="nt">from</span> <span class="nt">here</span> <span class="nt">on</span> <span class="nt">out</span><span class="o">.</span>
        <span class="nt">self</span><span class="nc">.started_request</span> <span class="o">=</span> <span class="nt">True</span>
        <span class="nt">if</span> <span class="nt">not</span> <span class="nt">request_line</span><span class="o">:</span>
            <span class="err">#</span> <span class="nt">Force</span> <span class="nt">self</span><span class="nc">.ready</span> <span class="o">=</span> <span class="nt">False</span> <span class="nt">so</span> <span class="nt">the</span> <span class="nt">connection</span> <span class="nt">will</span> <span class="nt">close</span><span class="o">.</span>
            <span class="nt">self</span><span class="nc">.ready</span> <span class="o">=</span> <span class="nt">False</span>
            <span class="nt">return</span>

        <span class="nt">if</span> <span class="nt">request_line</span> <span class="o">==</span> <span class="nt">CRLF</span><span class="o">:</span>
            <span class="err">#</span> <span class="nt">RFC</span> <span class="nt">2616</span> <span class="nt">sec</span> <span class="nt">4</span><span class="nc">.1</span><span class="o">:</span> <span class="s2">&quot;...if the server is reading the protocol</span>
<span class="s2">            # stream at the beginning of a message and receives a CRLF</span>
<span class="s2">            # first, it should ignore the CRLF.&quot;</span>
            <span class="err">#</span> <span class="nt">But</span> <span class="nt">only</span> <span class="nt">ignore</span> <span class="nt">one</span> <span class="nt">leading</span> <span class="nt">line</span><span class="o">!</span> <span class="nt">else</span> <span class="nt">we</span> <span class="nt">enable</span> <span class="nt">a</span> <span class="nt">DoS</span><span class="o">.</span>
            <span class="nt">request_line</span> <span class="o">=</span> <span class="nt">self</span><span class="nc">.rfile.readline</span><span class="o">()</span>
            <span class="nt">if</span> <span class="nt">not</span> <span class="nt">request_line</span><span class="o">:</span>
                <span class="nt">self</span><span class="nc">.ready</span> <span class="o">=</span> <span class="nt">False</span>
                <span class="nt">return</span>

        <span class="nt">if</span> <span class="nt">not</span> <span class="nt">request_line</span><span class="nc">.endswith</span><span class="o">(</span><span class="nt">CRLF</span><span class="o">):</span>
            <span class="nt">self</span><span class="nc">.simple_response</span><span class="o">(</span><span class="s2">&quot;400 Bad Request&quot;</span><span class="o">,</span> <span class="s2">&quot;HTTP requires CRLF terminators&quot;</span><span class="o">)</span>
            <span class="nt">return</span>

        <span class="nt">try</span><span class="o">:</span>
            <span class="nt">method</span><span class="o">,</span> <span class="nt">uri</span><span class="o">,</span> <span class="nt">req_protocol</span> <span class="o">=</span> <span class="nt">request_line</span><span class="nc">.strip</span><span class="o">()</span><span class="nc">.split</span><span class="o">(</span><span class="s2">&quot; &quot;</span><span class="o">,</span> <span class="nt">2</span><span class="o">)</span>
            <span class="nt">rp</span> <span class="o">=</span> <span class="nt">int</span><span class="o">(</span><span class="nt">req_protocol</span><span class="cp">[</span><span class="mi">5</span><span class="cp">]</span><span class="o">),</span> <span class="nt">int</span><span class="o">(</span><span class="nt">req_protocol</span><span class="cp">[</span><span class="mi">7</span><span class="cp">]</span><span class="o">)</span>
        <span class="nt">except</span> <span class="o">(</span><span class="nt">ValueError</span><span class="o">,</span> <span class="nt">IndexError</span><span class="o">):</span>
            <span class="nt">self</span><span class="nc">.simple_response</span><span class="o">(</span><span class="s2">&quot;400 Bad Request&quot;</span><span class="o">,</span> <span class="s2">&quot;Malformed Request-Line&quot;</span><span class="o">)</span>
            <span class="nt">return</span>

        <span class="nt">self</span><span class="nc">.uri</span> <span class="o">=</span> <span class="nt">uri</span>
        <span class="nt">self</span><span class="nc">.method</span> <span class="o">=</span> <span class="nt">method</span>

        <span class="err">#</span> <span class="nt">uri</span> <span class="nt">may</span> <span class="nt">be</span> <span class="nt">an</span> <span class="nt">abs_path</span> <span class="o">(</span><span class="nt">including</span> <span class="s2">&quot;http://host.domain.tld&quot;</span><span class="o">);</span>
        <span class="nt">scheme</span><span class="o">,</span> <span class="nt">authority</span><span class="o">,</span> <span class="nt">path</span> <span class="o">=</span> <span class="nt">self</span><span class="nc">.parse_request_uri</span><span class="o">(</span><span class="nt">uri</span><span class="o">)</span>
        <span class="nt">if</span> <span class="s1">&#39;#&#39;</span> <span class="nt">in</span> <span class="nt">path</span><span class="o">:</span>
            <span class="nt">self</span><span class="nc">.simple_response</span><span class="o">(</span><span class="s2">&quot;400 Bad Request&quot;</span><span class="o">,</span>
                                 <span class="s2">&quot;Illegal #fragment in Request-URI.&quot;</span><span class="o">)</span>
            <span class="nt">return</span>

        <span class="nt">if</span> <span class="nt">scheme</span><span class="o">:</span>
            <span class="nt">self</span><span class="nc">.scheme</span> <span class="o">=</span> <span class="nt">scheme</span>

        <span class="nt">qs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="nt">if</span> <span class="s1">&#39;?&#39;</span> <span class="nt">in</span> <span class="nt">path</span><span class="o">:</span>
            <span class="nt">path</span><span class="o">,</span> <span class="nt">qs</span> <span class="o">=</span> <span class="nt">path</span><span class="nc">.split</span><span class="o">(</span><span class="s1">&#39;?&#39;</span><span class="o">,</span> <span class="nt">1</span><span class="o">)</span>

        <span class="err">#</span> <span class="nt">Unquote</span> <span class="nt">the</span> <span class="nt">path</span><span class="o">+</span><span class="nt">params</span> <span class="o">(</span><span class="nt">e</span><span class="nc">.g</span><span class="o">.</span> <span class="s2">&quot;/this%20path&quot;</span> <span class="nt">-</span><span class="o">&gt;</span> <span class="s2">&quot;/this path&quot;</span><span class="o">).</span>
        <span class="err">#</span> <span class="nt">http</span><span class="o">://</span><span class="nt">www</span><span class="nc">.w3.org</span><span class="o">/</span><span class="nt">Protocols</span><span class="o">/</span><span class="nt">rfc2616</span><span class="o">/</span><span class="nt">rfc2616-sec5</span><span class="nc">.html</span><span class="nf">#sec5</span><span class="nc">.1.2</span>
        <span class="err">#</span>
        <span class="err">#</span> <span class="nt">But</span> <span class="nt">note</span> <span class="nt">that</span> <span class="s2">&quot;...a URI must be separated into its components</span>
<span class="s2">        # before the escaped characters within those components can be</span>
<span class="s2">        # safely decoded.&quot;</span> <span class="nt">http</span><span class="o">://</span><span class="nt">www</span><span class="nc">.ietf.org</span><span class="o">/</span><span class="nt">rfc</span><span class="o">/</span><span class="nt">rfc2396</span><span class="nc">.txt</span><span class="o">,</span> <span class="nt">sec</span> <span class="nt">2</span><span class="nc">.4.2</span>
        <span class="err">#</span> <span class="nt">Therefore</span><span class="o">,</span> <span class="s2">&quot;/this%2Fpath&quot;</span> <span class="nt">becomes</span> <span class="s2">&quot;/this%2Fpath&quot;</span><span class="o">,</span> <span class="nt">not</span> <span class="s2">&quot;/this/path&quot;</span><span class="o">.</span>
        <span class="nt">try</span><span class="o">:</span>
            <span class="nt">atoms</span> <span class="o">=</span> <span class="cp">[</span><span class="nx">unquote</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="nx">for</span> <span class="n">x</span> <span class="k">in</span> <span class="nx">quoted_slash.split</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="cp">]</span>
        <span class="nt">except</span> <span class="nt">ValueError</span><span class="o">,</span> <span class="nt">ex</span><span class="o">:</span>
            <span class="nt">self</span><span class="nc">.simple_response</span><span class="o">(</span><span class="s2">&quot;400 Bad Request&quot;</span><span class="o">,</span> <span class="nt">ex</span><span class="nc">.args</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="o">)</span>
            <span class="nt">return</span>
        <span class="nt">path</span> <span class="o">=</span> <span class="s2">&quot;%2F&quot;</span><span class="nc">.join</span><span class="o">(</span><span class="nt">atoms</span><span class="o">)</span>
        <span class="nt">self</span><span class="nc">.path</span> <span class="o">=</span> <span class="nt">path</span>

        <span class="err">#</span> <span class="nt">Note</span> <span class="nt">that</span><span class="o">,</span> <span class="nt">like</span> <span class="nt">wsgiref</span> <span class="nt">and</span> <span class="nt">most</span> <span class="nt">other</span> <span class="nt">HTTP</span> <span class="nt">servers</span><span class="o">,</span>
        <span class="err">#</span> <span class="nt">we</span> <span class="s2">&quot;% HEX HEX&quot;</span><span class="nt">-unquote</span> <span class="nt">the</span> <span class="nt">path</span> <span class="nt">but</span> <span class="nt">not</span> <span class="nt">the</span> <span class="nt">query</span> <span class="nt">string</span><span class="o">.</span>
        <span class="nt">self</span><span class="nc">.qs</span> <span class="o">=</span> <span class="nt">qs</span>

        <span class="err">#</span> <span class="nt">Compare</span> <span class="nt">request</span> <span class="nt">and</span> <span class="nt">server</span> <span class="nt">HTTP</span> <span class="nt">protocol</span> <span class="nt">versions</span><span class="o">,</span> <span class="nt">in</span> <span class="nt">case</span> <span class="nt">our</span>
        <span class="err">#</span> <span class="nt">server</span> <span class="nt">does</span> <span class="nt">not</span> <span class="nt">support</span> <span class="nt">the</span> <span class="nt">requested</span> <span class="nt">protocol</span><span class="o">.</span> <span class="nt">Limit</span> <span class="nt">our</span> <span class="nt">output</span>
        <span class="err">#</span> <span class="nt">to</span> <span class="nt">min</span><span class="o">(</span><span class="nt">req</span><span class="o">,</span> <span class="nt">server</span><span class="o">).</span> <span class="nt">We</span> <span class="nt">want</span> <span class="nt">the</span> <span class="nt">following</span> <span class="nt">output</span><span class="o">:</span>
        <span class="err">#</span>     <span class="nt">request</span>    <span class="nt">server</span>     <span class="nt">actual</span> <span class="nt">written</span>   <span class="nt">supported</span> <span class="nt">response</span>
        <span class="err">#</span>     <span class="nt">protocol</span>   <span class="nt">protocol</span>  <span class="nt">response</span> <span class="nt">protocol</span>    <span class="nt">feature</span> <span class="nt">set</span>
        <span class="err">#</span> <span class="nt">a</span>     <span class="nt">1</span><span class="nc">.0</span>        <span class="nt">1</span><span class="nc">.0</span>           <span class="nt">1</span><span class="nc">.0</span>                <span class="nt">1</span><span class="nc">.0</span>
        <span class="err">#</span> <span class="nt">b</span>     <span class="nt">1</span><span class="nc">.0</span>        <span class="nt">1</span><span class="nc">.1</span>           <span class="nt">1</span><span class="nc">.1</span>                <span class="nt">1</span><span class="nc">.0</span>
        <span class="err">#</span> <span class="nt">c</span>     <span class="nt">1</span><span class="nc">.1</span>        <span class="nt">1</span><span class="nc">.0</span>           <span class="nt">1</span><span class="nc">.0</span>                <span class="nt">1</span><span class="nc">.0</span>
        <span class="err">#</span> <span class="nt">d</span>     <span class="nt">1</span><span class="nc">.1</span>        <span class="nt">1</span><span class="nc">.1</span>           <span class="nt">1</span><span class="nc">.1</span>                <span class="nt">1</span><span class="nc">.1</span>
        <span class="err">#</span> <span class="nt">Notice</span> <span class="nt">that</span><span class="o">,</span> <span class="nt">in</span> <span class="o">(</span><span class="nt">b</span><span class="o">),</span> <span class="nt">the</span> <span class="nt">response</span> <span class="nt">will</span> <span class="nt">be</span> <span class="s2">&quot;HTTP/1.1&quot;</span> <span class="nt">even</span> <span class="nt">though</span>
        <span class="err">#</span> <span class="nt">the</span> <span class="nt">client</span> <span class="nt">only</span> <span class="nt">understands</span> <span class="nt">1</span><span class="nc">.0</span><span class="o">.</span> <span class="nt">RFC</span> <span class="nt">2616</span> <span class="nt">10</span><span class="nc">.5.6</span> <span class="nt">says</span> <span class="nt">we</span> <span class="nt">should</span>
        <span class="err">#</span> <span class="nt">only</span> <span class="nt">return</span> <span class="nt">505</span> <span class="nt">if</span> <span class="nt">the</span> <span class="nt">_major_</span> <span class="nt">version</span> <span class="nt">is</span> <span class="nt">different</span><span class="o">.</span>
        <span class="nt">sp</span> <span class="o">=</span> <span class="nt">int</span><span class="o">(</span><span class="nt">self</span><span class="nc">.server.protocol</span><span class="cp">[</span><span class="mi">5</span><span class="cp">]</span><span class="o">),</span> <span class="nt">int</span><span class="o">(</span><span class="nt">self</span><span class="nc">.server.protocol</span><span class="cp">[</span><span class="mi">7</span><span class="cp">]</span><span class="o">)</span>

        <span class="nt">if</span> <span class="nt">sp</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span> <span class="o">!=</span> <span class="nt">rp</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="o">:</span>
            <span class="nt">self</span><span class="nc">.simple_response</span><span class="o">(</span><span class="s2">&quot;505 HTTP Version Not Supported&quot;</span><span class="o">)</span>
            <span class="nt">return</span>
        <span class="nt">self</span><span class="nc">.request_protocol</span> <span class="o">=</span> <span class="nt">req_protocol</span>
        <span class="nt">self</span><span class="nc">.response_protocol</span> <span class="o">=</span> <span class="s2">&quot;HTTP/%s.%s&quot;</span> <span class="o">%</span> <span class="nt">min</span><span class="o">(</span><span class="nt">rp</span><span class="o">,</span> <span class="nt">sp</span><span class="o">)</span>

    <span class="nt">def</span> <span class="nt">read_request_headers</span><span class="o">(</span><span class="nt">self</span><span class="o">):</span>
        <span class="s2">&quot;&quot;&quot;Read self.rfile into self.inheaders. Return success.&quot;&quot;&quot;</span>

        <span class="err">#</span> <span class="nt">then</span> <span class="nt">all</span> <span class="nt">the</span> <span class="nt">http</span> <span class="nt">headers</span>
        <span class="nt">try</span><span class="o">:</span>
            <span class="nt">read_headers</span><span class="o">(</span><span class="nt">self</span><span class="nc">.rfile</span><span class="o">,</span> <span class="nt">self</span><span class="nc">.inheaders</span><span class="o">)</span>
        <span class="nt">except</span> <span class="nt">ValueError</span><span class="o">,</span> <span class="nt">ex</span><span class="o">:</span>
            <span class="nt">self</span><span class="nc">.simple_response</span><span class="o">(</span><span class="s2">&quot;400 Bad Request&quot;</span><span class="o">,</span> <span class="nt">ex</span><span class="nc">.args</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="o">)</span>
            <span class="nt">return</span> <span class="nt">False</span>

        <span class="nt">mrbs</span> <span class="o">=</span> <span class="nt">self</span><span class="nc">.server.max_request_body_size</span>
        <span class="nt">if</span> <span class="nt">mrbs</span> <span class="nt">and</span> <span class="nt">int</span><span class="o">(</span><span class="nt">self</span><span class="nc">.inheaders.get</span><span class="o">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="o">,</span> <span class="nt">0</span><span class="o">))</span> <span class="o">&gt;</span> <span class="nt">mrbs</span><span class="o">:</span>
            <span class="nt">self</span><span class="nc">.simple_response</span><span class="o">(</span><span class="s2">&quot;413 Request Entity Too Large&quot;</span><span class="o">,</span>
                <span class="s2">&quot;The entity sent with the request exceeds the maximum &quot;</span>
                <span class="s2">&quot;allowed bytes.&quot;</span><span class="o">)</span>
            <span class="nt">return</span> <span class="nt">False</span>

        <span class="err">#</span> <span class="nt">Persistent</span> <span class="nt">connection</span> <span class="nt">support</span>
        <span class="nt">if</span> <span class="nt">self</span><span class="nc">.response_protocol</span> <span class="o">==</span> <span class="s2">&quot;HTTP/1.1&quot;</span><span class="o">:</span>
            <span class="err">#</span> <span class="nt">Both</span> <span class="nt">server</span> <span class="nt">and</span> <span class="nt">client</span> <span class="nt">are</span> <span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="nc">.1</span>
            <span class="nt">if</span> <span class="nt">self</span><span class="nc">.inheaders.get</span><span class="o">(</span><span class="s2">&quot;Connection&quot;</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="s2">&quot;close&quot;</span><span class="o">:</span>
                <span class="nt">self</span><span class="nc">.close_connection</span> <span class="o">=</span> <span class="nt">True</span>
        <span class="nt">else</span><span class="o">:</span>
            <span class="err">#</span> <span class="nt">Either</span> <span class="nt">the</span> <span class="nt">server</span> <span class="nt">or</span> <span class="nt">client</span> <span class="o">(</span><span class="nt">or</span> <span class="nt">both</span><span class="o">)</span> <span class="nt">are</span> <span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="nc">.0</span>
            <span class="nt">if</span> <span class="nt">self</span><span class="nc">.inheaders.get</span><span class="o">(</span><span class="s2">&quot;Connection&quot;</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">!=</span> <span class="s2">&quot;Keep-Alive&quot;</span><span class="o">:</span>
                <span class="nt">self</span><span class="nc">.close_connection</span> <span class="o">=</span> <span class="nt">True</span>

        <span class="err">#</span> <span class="nt">Transfer-Encoding</span> <span class="nt">support</span>
        <span class="nt">te</span> <span class="o">=</span> <span class="nt">None</span>
        <span class="nt">if</span> <span class="nt">self</span><span class="nc">.response_protocol</span> <span class="o">==</span> <span class="s2">&quot;HTTP/1.1&quot;</span><span class="o">:</span>
            <span class="nt">te</span> <span class="o">=</span> <span class="nt">self</span><span class="nc">.inheaders.get</span><span class="o">(</span><span class="s2">&quot;Transfer-Encoding&quot;</span><span class="o">)</span>
            <span class="nt">if</span> <span class="nt">te</span><span class="o">:</span>
                <span class="nt">te</span> <span class="o">=</span> <span class="cp">[</span><span class="nx">x.strip</span><span class="p">()</span><span class="bp">.</span><span class="nx-Member">lower</span><span class="p">()</span> <span class="nx">for</span> <span class="n">x</span> <span class="k">in</span> <span class="nx">te.split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">x.strip</span><span class="p">()</span><span class="cp">]</span>

        <span class="nt">self</span><span class="nc">.chunked_read</span> <span class="o">=</span> <span class="nt">False</span>

        <span class="nt">if</span> <span class="nt">te</span><span class="o">:</span>
            <span class="nt">for</span> <span class="nt">enc</span> <span class="nt">in</span> <span class="nt">te</span><span class="o">:</span>
                <span class="nt">if</span> <span class="nt">enc</span> <span class="o">==</span> <span class="s2">&quot;chunked&quot;</span><span class="o">:</span>
                    <span class="nt">self</span><span class="nc">.chunked_read</span> <span class="o">=</span> <span class="nt">True</span>
                <span class="nt">else</span><span class="o">:</span>
                    <span class="err">#</span> <span class="nt">Note</span> <span class="nt">that</span><span class="o">,</span> <span class="nt">even</span> <span class="nt">if</span> <span class="nt">we</span> <span class="nt">see</span> <span class="s2">&quot;chunked&quot;</span><span class="o">,</span> <span class="nt">we</span> <span class="nt">must</span> <span class="nt">reject</span>
                    <span class="err">#</span> <span class="nt">if</span> <span class="nt">there</span> <span class="nt">is</span> <span class="nt">an</span> <span class="nt">extension</span> <span class="nt">we</span> <span class="nt">don</span><span class="s1">&#39;t recognize.</span>
<span class="s1">                    self.simple_response(&quot;501 Unimplemented&quot;)</span>
<span class="s1">                    self.close_connection = True</span>
<span class="s1">                    return False</span>

<span class="s1">        # From PEP 333:</span>
<span class="s1">        # &quot;Servers and gateways that implement HTTP 1.1 must provide</span>
<span class="s1">        # transparent support for HTTP 1.1&#39;</span><span class="nt">s</span> <span class="s2">&quot;expect/continue&quot;</span> <span class="nt">mechanism</span><span class="o">.</span>
        <span class="err">#</span> <span class="nt">This</span> <span class="nt">may</span> <span class="nt">be</span> <span class="nt">done</span> <span class="nt">in</span> <span class="nt">any</span> <span class="nt">of</span> <span class="nt">several</span> <span class="nt">ways</span><span class="o">:</span>
        <span class="err">#</span>   <span class="nt">1</span><span class="o">.</span> <span class="nt">Respond</span> <span class="nt">to</span> <span class="nt">requests</span> <span class="nt">containing</span> <span class="nt">an</span> <span class="nt">Expect</span><span class="o">:</span> <span class="nt">100-continue</span> <span class="nt">request</span>
        <span class="err">#</span>      <span class="nt">with</span> <span class="nt">an</span> <span class="nt">immediate</span> <span class="s2">&quot;100 Continue&quot;</span> <span class="nt">response</span><span class="o">,</span> <span class="nt">and</span> <span class="nt">proceed</span> <span class="nt">normally</span><span class="o">.</span>
        <span class="err">#</span>   <span class="nt">2</span><span class="o">.</span> <span class="nt">Proceed</span> <span class="nt">with</span> <span class="nt">the</span> <span class="nt">request</span> <span class="nt">normally</span><span class="o">,</span> <span class="nt">but</span> <span class="nt">provide</span> <span class="nt">the</span> <span class="nt">application</span>
        <span class="err">#</span>      <span class="nt">with</span> <span class="nt">a</span> <span class="nt">wsgi</span><span class="nc">.input</span> <span class="nt">stream</span> <span class="nt">that</span> <span class="nt">will</span> <span class="nt">send</span> <span class="nt">the</span> <span class="s2">&quot;100 Continue&quot;</span>
        <span class="err">#</span>      <span class="nt">response</span> <span class="nt">if</span><span class="o">/</span><span class="nt">when</span> <span class="nt">the</span> <span class="nt">application</span> <span class="nt">first</span> <span class="nt">attempts</span> <span class="nt">to</span> <span class="nt">read</span> <span class="nt">from</span>
        <span class="err">#</span>      <span class="nt">the</span> <span class="nt">input</span> <span class="nt">stream</span><span class="o">.</span> <span class="nt">The</span> <span class="nt">read</span> <span class="nt">request</span> <span class="nt">must</span> <span class="nt">then</span> <span class="nt">remain</span> <span class="nt">blocked</span>
        <span class="err">#</span>      <span class="nt">until</span> <span class="nt">the</span> <span class="nt">client</span> <span class="nt">responds</span><span class="o">.</span>
        <span class="err">#</span>   <span class="nt">3</span><span class="o">.</span> <span class="nt">Wait</span> <span class="nt">until</span> <span class="nt">the</span> <span class="nt">client</span> <span class="nt">decides</span> <span class="nt">that</span> <span class="nt">the</span> <span class="nt">server</span> <span class="nt">does</span> <span class="nt">not</span> <span class="nt">support</span>
        <span class="err">#</span>      <span class="nt">expect</span><span class="o">/</span><span class="nt">continue</span><span class="o">,</span> <span class="nt">and</span> <span class="nt">sends</span> <span class="nt">the</span> <span class="nt">request</span> <span class="nt">body</span> <span class="nt">on</span> <span class="nt">its</span> <span class="nt">own</span><span class="o">.</span>
        <span class="err">#</span>      <span class="o">(</span><span class="nt">This</span> <span class="nt">is</span> <span class="nt">suboptimal</span><span class="o">,</span> <span class="nt">and</span> <span class="nt">is</span> <span class="nt">not</span> <span class="nt">recommended</span><span class="o">.)</span>
        <span class="err">#</span>
        <span class="err">#</span> <span class="nt">We</span> <span class="nt">used</span> <span class="nt">to</span> <span class="nt">do</span> <span class="nt">3</span><span class="o">,</span> <span class="nt">but</span> <span class="nt">are</span> <span class="nt">now</span> <span class="nt">doing</span> <span class="nt">1</span><span class="o">.</span> <span class="nt">Maybe</span> <span class="nt">we</span><span class="s1">&#39;ll do 2 someday,</span>
<span class="s1">        # but it seems like it would be a big slowdown for such a rare case.</span>
<span class="s1">        if self.inheaders.get(&quot;Expect&quot;, &quot;&quot;) == &quot;100-continue&quot;:</span>
<span class="s1">            # Don&#39;</span><span class="nt">t</span> <span class="nt">use</span> <span class="nt">simple_response</span> <span class="nt">here</span><span class="o">,</span> <span class="nt">because</span> <span class="nt">it</span> <span class="nt">emits</span> <span class="nt">headers</span>
            <span class="err">#</span> <span class="nt">we</span> <span class="nt">don</span><span class="s1">&#39;t want. See http://www.cherrypy.org/ticket/951</span>
<span class="s1">            msg = self.server.protocol + &quot; 100 Continue\r\n\r\n&quot;</span>
<span class="s1">            try:</span>
<span class="s1">                self.conn.wfile.sendall(msg)</span>
<span class="s1">            except socket.error, x:</span>
<span class="s1">                if x.args</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="s1"> not in socket_errors_to_ignore:</span>
<span class="s1">                    raise</span>
<span class="s1">        return True</span>

<span class="s1">    def parse_request_uri(self, uri):</span>
<span class="s1">        &quot;&quot;&quot;Parse a Request-URI into (scheme, authority, path).</span>

<span class="s1">        Note that Request-URI&#39;</span><span class="nt">s</span> <span class="nt">must</span> <span class="nt">be</span> <span class="nt">one</span> <span class="nt">of</span><span class="o">::</span>

            <span class="nt">Request-URI</span>    <span class="o">=</span> <span class="s2">&quot;*&quot;</span> <span class="o">|</span> <span class="nt">absoluteURI</span> <span class="o">|</span> <span class="nt">abs_path</span> <span class="o">|</span> <span class="nt">authority</span>

        <span class="nt">Therefore</span><span class="o">,</span> <span class="nt">a</span> <span class="nt">Request-URI</span> <span class="nt">which</span> <span class="nt">starts</span> <span class="nt">with</span> <span class="nt">a</span> <span class="nt">double</span> <span class="nt">forward-slash</span>
        <span class="nt">cannot</span> <span class="nt">be</span> <span class="nt">a</span> <span class="s2">&quot;net_path&quot;</span><span class="o">::</span>

            <span class="nt">net_path</span>      <span class="o">=</span> <span class="s2">&quot;//&quot;</span> <span class="nt">authority</span> <span class="cp">[</span> <span class="nx">abs_path</span> <span class="cp">]</span>

        <span class="nt">Instead</span><span class="o">,</span> <span class="nt">it</span> <span class="nt">must</span> <span class="nt">be</span> <span class="nt">interpreted</span> <span class="nt">as</span> <span class="nt">an</span> <span class="s2">&quot;abs_path&quot;</span> <span class="nt">with</span> <span class="nt">an</span> <span class="nt">empty</span> <span class="nt">first</span>
        <span class="nt">path</span> <span class="nt">segment</span><span class="o">::</span>

            <span class="nt">abs_path</span>      <span class="o">=</span> <span class="s2">&quot;/&quot;</span>  <span class="nt">path_segments</span>
            <span class="nt">path_segments</span> <span class="o">=</span> <span class="nt">segment</span> <span class="o">*(</span> <span class="s2">&quot;/&quot;</span> <span class="nt">segment</span> <span class="o">)</span>
            <span class="nt">segment</span>       <span class="o">=</span> <span class="o">*</span><span class="nt">pchar</span> <span class="o">*(</span> <span class="s2">&quot;;&quot;</span> <span class="nt">param</span> <span class="o">)</span>
            <span class="nt">param</span>         <span class="o">=</span> <span class="o">*</span><span class="nt">pchar</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        if uri == &quot;</span><span class="o">*</span><span class="s2">&quot;:</span>
<span class="s2">            return None, None, uri</span>

<span class="s2">        i = uri.find(&#39;://&#39;)</span>
<span class="s2">        if i &gt; 0 and &#39;?&#39; not in uri</span><span class="cp">[</span><span class="p">:</span><span class="nx">i</span><span class="cp">]</span><span class="s2">:</span>
<span class="s2">            # An absoluteURI.</span>
<span class="s2">            # If there&#39;s a scheme (and it must be http or https), then:</span>
<span class="s2">            # http_URL = &quot;</span><span class="nt">http</span><span class="o">:</span><span class="s2">&quot; &quot;</span><span class="o">//</span><span class="s2">&quot; host </span><span class="cp">[</span> <span class="s2">&quot;:&quot;</span> <span class="nx">port</span> <span class="cp">]</span><span class="s2"> </span><span class="cp">[</span> <span class="nx">abs_path</span> <span class="err">[</span> <span class="s2">&quot;?&quot;</span> <span class="nx">query</span> <span class="cp">]</span><span class="s2">]</span>
<span class="s2">            scheme, remainder = uri</span><span class="cp">[</span><span class="p">:</span><span class="nx">i</span><span class="cp">]</span><span class="s2">.lower(), uri</span><span class="cp">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">:</span><span class="cp">]</span><span class="s2"></span>
<span class="s2">            authority, path = remainder.split(&quot;</span><span class="o">/</span><span class="s2">&quot;, 1)</span>
<span class="s2">            return scheme, authority, path</span>

<span class="s2">        if uri.startswith(&#39;/&#39;):</span>
<span class="s2">            # An abs_path.</span>
<span class="s2">            return None, None, uri</span>
<span class="s2">        else:</span>
<span class="s2">            # An authority.</span>
<span class="s2">            return None, uri, None</span>

<span class="s2">    def respond(self):</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="nt">Call</span> <span class="nt">the</span> <span class="nt">gateway</span> <span class="nt">and</span> <span class="nt">write</span> <span class="nt">its</span> <span class="nt">iterable</span> <span class="nt">output</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        mrbs = self.server.max_request_body_size</span>
<span class="s2">        if self.chunked_read:</span>
<span class="s2">            self.rfile = ChunkedRFile(self.conn.rfile, mrbs)</span>
<span class="s2">        else:</span>
<span class="s2">            cl = int(self.inheaders.get(&quot;</span><span class="nt">Content-Length</span><span class="s2">&quot;, 0))</span>
<span class="s2">            if mrbs and mrbs &lt; cl:</span>
<span class="s2">                if not self.sent_headers:</span>
<span class="s2">                    self.simple_response(&quot;</span><span class="nt">413</span> <span class="nt">Request</span> <span class="nt">Entity</span> <span class="nt">Too</span> <span class="nt">Large</span><span class="s2">&quot;,</span>
<span class="s2">                        &quot;</span><span class="nt">The</span> <span class="nt">entity</span> <span class="nt">sent</span> <span class="nt">with</span> <span class="nt">the</span> <span class="nt">request</span> <span class="nt">exceeds</span> <span class="nt">the</span> <span class="nt">maximum</span> <span class="s2">&quot;</span>
<span class="s2">                        &quot;</span><span class="nt">allowed</span> <span class="nt">bytes</span><span class="o">.</span><span class="s2">&quot;)</span>
<span class="s2">                return</span>
<span class="s2">            self.rfile = KnownLengthRFile(self.conn.rfile, cl)</span>

<span class="s2">        self.server.gateway(self).respond()</span>

<span class="s2">        if (self.ready and not self.sent_headers):</span>
<span class="s2">            self.sent_headers = True</span>
<span class="s2">            self.send_headers()</span>
<span class="s2">        if self.chunked_write:</span>
<span class="s2">            self.conn.wfile.sendall(&quot;</span><span class="nt">0</span><span class="err">\</span><span class="nt">r</span><span class="err">\</span><span class="nt">n</span><span class="err">\</span><span class="nt">r</span><span class="err">\</span><span class="nt">n</span><span class="s2">&quot;)</span>

<span class="s2">    def simple_response(self, status, msg=&quot;&quot;):</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="nt">Write</span> <span class="nt">a</span> <span class="nt">simple</span> <span class="nt">response</span> <span class="nt">back</span> <span class="nt">to</span> <span class="nt">the</span> <span class="nt">client</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        status = str(status)</span>
<span class="s2">        buf = </span><span class="cp">[</span><span class="bp">self.</span><span class="nx-Member">server.protocol</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span>
               <span class="nx">status</span> <span class="o">+</span> <span class="nx">CRLF</span><span class="p">,</span>
               <span class="s2">&quot;Content-Length: %s</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nx">len</span><span class="p">(</span><span class="nx">msg</span><span class="p">),</span>
               <span class="s2">&quot;Content-Type: text/plain</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="cp">]</span><span class="s2"></span>

<span class="s2">        if status</span><span class="cp">[</span><span class="p">:</span><span class="mi">3</span><span class="cp">]</span><span class="s2"> in (&quot;</span><span class="nt">413</span><span class="s2">&quot;, &quot;</span><span class="nt">414</span><span class="s2">&quot;):</span>
<span class="s2">            # Request Entity Too Large / Request-URI Too Long</span>
<span class="s2">            self.close_connection = True</span>
<span class="s2">            if self.response_protocol == &#39;HTTP/1.1&#39;:</span>
<span class="s2">                # This will not be true for 414, since read_request_line</span>
<span class="s2">                # usually raises 414 before reading the whole line, and we</span>
<span class="s2">                # therefore cannot know the proper response_protocol.</span>
<span class="s2">                buf.append(&quot;</span><span class="nt">Connection</span><span class="o">:</span> <span class="nt">close</span><span class="err">\</span><span class="nt">r</span><span class="err">\</span><span class="nt">n</span><span class="s2">&quot;)</span>
<span class="s2">            else:</span>
<span class="s2">                # HTTP/1.0 had no 413/414 status nor Connection header.</span>
<span class="s2">                # Emit 400 instead and trust the message body is enough.</span>
<span class="s2">                status = &quot;</span><span class="nt">400</span> <span class="nt">Bad</span> <span class="nt">Request</span><span class="s2">&quot;</span>

<span class="s2">        buf.append(CRLF)</span>
<span class="s2">        if msg:</span>
<span class="s2">            if isinstance(msg, unicode):</span>
<span class="s2">                msg = msg.encode(&quot;</span><span class="nt">ISO-8859-1</span><span class="s2">&quot;)</span>
<span class="s2">            buf.append(msg)</span>

<span class="s2">        try:</span>
<span class="s2">            self.conn.wfile.sendall(&quot;&quot;.join(buf))</span>
<span class="s2">        except socket.error, x:</span>
<span class="s2">            if x.args</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="s2"> not in socket_errors_to_ignore:</span>
<span class="s2">                raise</span>

<span class="s2">    def write(self, chunk):</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="nt">Write</span> <span class="nt">unbuffered</span> <span class="nt">data</span> <span class="nt">to</span> <span class="nt">the</span> <span class="nt">client</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        if self.chunked_write and chunk:</span>
<span class="s2">            buf = </span><span class="cp">[</span><span class="nx">hex</span><span class="p">(</span><span class="nx">len</span><span class="p">(</span><span class="nx">chunk</span><span class="p">))</span><span class="err">[</span><span class="mi">2</span><span class="p">:</span><span class="cp">]</span><span class="s2">, CRLF, chunk, CRLF]</span>
<span class="s2">            self.conn.wfile.sendall(&quot;&quot;.join(buf))</span>
<span class="s2">        else:</span>
<span class="s2">            self.conn.wfile.sendall(chunk)</span>

<span class="s2">    def send_headers(self):</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="nt">Assert</span><span class="o">,</span> <span class="nt">process</span><span class="o">,</span> <span class="nt">and</span> <span class="nt">send</span> <span class="nt">the</span> <span class="nt">HTTP</span> <span class="nt">response</span> <span class="nt">message-headers</span><span class="o">.</span>

        <span class="nt">You</span> <span class="nt">must</span> <span class="nt">set</span> <span class="nt">self</span><span class="nc">.status</span><span class="o">,</span> <span class="nt">and</span> <span class="nt">self</span><span class="nc">.outheaders</span> <span class="nt">before</span> <span class="nt">calling</span> <span class="nt">this</span><span class="o">.</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        hkeys = </span><span class="cp">[</span><span class="nx">key.lower</span><span class="p">()</span> <span class="nx">for</span> <span class="nx">key</span><span class="p">,</span> <span class="n">value</span> <span class="k">in</span> <span class="bp">self.</span><span class="nx-Member">outheaders</span><span class="cp">]</span><span class="s2"></span>
<span class="s2">        status = int(self.status</span><span class="cp">[</span><span class="p">:</span><span class="mi">3</span><span class="cp">]</span><span class="s2">)</span>

<span class="s2">        if status == 413:</span>
<span class="s2">            # Request Entity Too Large. Close conn to avoid garbage.</span>
<span class="s2">            self.close_connection = True</span>
<span class="s2">        elif &quot;</span><span class="nt">content-length</span><span class="s2">&quot; not in hkeys:</span>
<span class="s2">            # &quot;</span><span class="nt">All</span> <span class="nt">1xx</span> <span class="o">(</span><span class="nt">informational</span><span class="o">),</span> <span class="nt">204</span> <span class="o">(</span><span class="nt">no</span> <span class="nt">content</span><span class="o">),</span>
            <span class="err">#</span> <span class="nt">and</span> <span class="nt">304</span> <span class="o">(</span><span class="nt">not</span> <span class="nt">modified</span><span class="o">)</span> <span class="nt">responses</span> <span class="nt">MUST</span> <span class="nt">NOT</span>
            <span class="err">#</span> <span class="nt">include</span> <span class="nt">a</span> <span class="nt">message-body</span><span class="o">.</span><span class="s2">&quot; So no point chunking.</span>
<span class="s2">            if status &lt; 200 or status in (204, 205, 304):</span>
<span class="s2">                pass</span>
<span class="s2">            else:</span>
<span class="s2">                if (self.response_protocol == &#39;HTTP/1.1&#39;</span>
<span class="s2">                    and self.method != &#39;HEAD&#39;):</span>
<span class="s2">                    # Use the chunked transfer-coding</span>
<span class="s2">                    self.chunked_write = True</span>
<span class="s2">                    self.outheaders.append((&quot;</span><span class="nt">Transfer-Encoding</span><span class="s2">&quot;, &quot;</span><span class="nt">chunked</span><span class="s2">&quot;))</span>
<span class="s2">                else:</span>
<span class="s2">                    # Closing the conn is the only way to determine len.</span>
<span class="s2">                    self.close_connection = True</span>

<span class="s2">        if &quot;</span><span class="nt">connection</span><span class="s2">&quot; not in hkeys:</span>
<span class="s2">            if self.response_protocol == &#39;HTTP/1.1&#39;:</span>
<span class="s2">                # Both server and client are HTTP/1.1 or better</span>
<span class="s2">                if self.close_connection:</span>
<span class="s2">                    self.outheaders.append((&quot;</span><span class="nt">Connection</span><span class="s2">&quot;, &quot;</span><span class="nt">close</span><span class="s2">&quot;))</span>
<span class="s2">            else:</span>
<span class="s2">                # Server and/or client are HTTP/1.0</span>
<span class="s2">                if not self.close_connection:</span>
<span class="s2">                    self.outheaders.append((&quot;</span><span class="nt">Connection</span><span class="s2">&quot;, &quot;</span><span class="nt">Keep-Alive</span><span class="s2">&quot;))</span>

<span class="s2">        if (not self.close_connection) and (not self.chunked_read):</span>
<span class="s2">            # Read any remaining request body data on the socket.</span>
<span class="s2">            # &quot;</span><span class="nt">If</span> <span class="nt">an</span> <span class="nt">origin</span> <span class="nt">server</span> <span class="nt">receives</span> <span class="nt">a</span> <span class="nt">request</span> <span class="nt">that</span> <span class="nt">does</span> <span class="nt">not</span> <span class="nt">include</span> <span class="nt">an</span>
            <span class="err">#</span> <span class="nt">Expect</span> <span class="nt">request-header</span> <span class="nt">field</span> <span class="nt">with</span> <span class="nt">the</span> <span class="s2">&quot;100-continue&quot;</span> <span class="nt">expectation</span><span class="o">,</span>
            <span class="err">#</span> <span class="nt">the</span> <span class="nt">request</span> <span class="nt">includes</span> <span class="nt">a</span> <span class="nt">request</span> <span class="nt">body</span><span class="o">,</span> <span class="nt">and</span> <span class="nt">the</span> <span class="nt">server</span> <span class="nt">responds</span>
            <span class="err">#</span> <span class="nt">with</span> <span class="nt">a</span> <span class="nt">final</span> <span class="nt">status</span> <span class="nt">code</span> <span class="nt">before</span> <span class="nt">reading</span> <span class="nt">the</span> <span class="nt">entire</span> <span class="nt">request</span> <span class="nt">body</span>
            <span class="err">#</span> <span class="nt">from</span> <span class="nt">the</span> <span class="nt">transport</span> <span class="nt">connection</span><span class="o">,</span> <span class="nt">then</span> <span class="nt">the</span> <span class="nt">server</span> <span class="nt">SHOULD</span> <span class="nt">NOT</span> <span class="nt">close</span>
            <span class="err">#</span> <span class="nt">the</span> <span class="nt">transport</span> <span class="nt">connection</span> <span class="nt">until</span> <span class="nt">it</span> <span class="nt">has</span> <span class="nt">read</span> <span class="nt">the</span> <span class="nt">entire</span> <span class="nt">request</span><span class="o">,</span>
            <span class="err">#</span> <span class="nt">or</span> <span class="nt">until</span> <span class="nt">the</span> <span class="nt">client</span> <span class="nt">closes</span> <span class="nt">the</span> <span class="nt">connection</span><span class="o">.</span> <span class="nt">Otherwise</span><span class="o">,</span> <span class="nt">the</span> <span class="nt">client</span>
            <span class="err">#</span> <span class="nt">might</span> <span class="nt">not</span> <span class="nt">reliably</span> <span class="nt">receive</span> <span class="nt">the</span> <span class="nt">response</span> <span class="nt">message</span><span class="o">.</span> <span class="nt">However</span><span class="o">,</span> <span class="nt">this</span>
            <span class="err">#</span> <span class="nt">requirement</span> <span class="nt">is</span> <span class="nt">not</span> <span class="nt">be</span> <span class="nt">construed</span> <span class="nt">as</span> <span class="nt">preventing</span> <span class="nt">a</span> <span class="nt">server</span> <span class="nt">from</span>
            <span class="err">#</span> <span class="nt">defending</span> <span class="nt">itself</span> <span class="nt">against</span> <span class="nt">denial-of-service</span> <span class="nt">attacks</span><span class="o">,</span> <span class="nt">or</span> <span class="nt">from</span>
            <span class="err">#</span> <span class="nt">badly</span> <span class="nt">broken</span> <span class="nt">client</span> <span class="nt">implementations</span><span class="o">.</span><span class="s2">&quot;</span>
<span class="s2">            remaining = getattr(self.rfile, &#39;remaining&#39;, 0)</span>
<span class="s2">            if remaining &gt; 0:</span>
<span class="s2">                self.rfile.read(remaining)</span>

<span class="s2">        if &quot;</span><span class="nt">date</span><span class="s2">&quot; not in hkeys:</span>
<span class="s2">            self.outheaders.append((&quot;</span><span class="nt">Date</span><span class="s2">&quot;, rfc822.formatdate()))</span>

<span class="s2">        if &quot;</span><span class="nt">server</span><span class="s2">&quot; not in hkeys:</span>
<span class="s2">            self.outheaders.append((&quot;</span><span class="nt">Server</span><span class="s2">&quot;, self.server.server_name))</span>

<span class="s2">        buf = </span><span class="cp">[</span><span class="bp">self.</span><span class="nx-Member">server.protocol</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self.</span><span class="nb">status</span> <span class="o">+</span> <span class="nx">CRLF</span><span class="cp">]</span><span class="s2"></span>
<span class="s2">        for k, v in self.outheaders:</span>
<span class="s2">            buf.append(k + &quot;</span><span class="o">:</span> <span class="s2">&quot; + v + CRLF)</span>
<span class="s2">        buf.append(CRLF)</span>
<span class="s2">        self.conn.wfile.sendall(&quot;</span><span class="err">&quot;</span><span class="nc">.join</span><span class="o">(</span><span class="nt">buf</span><span class="o">))</span>
</pre></div>


<p><strong>CP_fileobject</strong>:<br />
对socket又进行了一层封装，主要对read，write方法进行了封装重写，看这个得结合socket的源码一起看会更清晰一些(在后面)。   </p>
<div class="highlight"><pre>* _sendall:_  非阻塞的将所有的data全部send出去，方法还是调用的socket的send(见_fileobject的send实现)
* _send:_ 调用_fileobject的send方法，并将send成功的数据加入到bytes_written
* _flush:_ 将_fileobject中的_wbuf的缓存data，一次性sendall出去
* _recv:_ 调用_fileobject.sock.recv接收指定大小的data，并将大小写进bytes_read   
* _read:_ （根据socket的rbuf的实现，分两种进行封装，StringIO和basestring，我这边的版本是StringIO，我们看StringIO版本的封装。其实处理方法都是以一致的。）如果没指定读的size，recv一次buf的大小，然后合并rbuf和新recv的返回。如果指定了大小size，buf中存的已经大于size，直接返回buf中的size，剩下的重写进rbuf，否则重新收size-len(rbuf)的数据，确保接受正确完成，清空rbuf，返回数据  
* _readline:_  readline基本上和read形似，不过判断终止条件的时候需要结合\n,代码好理解，有兴趣的直接看吧~

class CP_fileobject(socket._fileobject):
&quot;&quot;&quot;Faux file object attached to a socket object.&quot;&quot;&quot;

def __init__(self, *args, **kwargs):
    self.bytes_read = 0
    self.bytes_written = 0
    socket._fileobject.__init__(self, *args, **kwargs)

def sendall(self, data):
    &quot;&quot;&quot;Sendall for non-blocking sockets.&quot;&quot;&quot;
    while data:
        try:
            bytes_sent = self.send(data)
            data = data[bytes_sent:]
        except socket.error, e:
            if e.args[0] not in socket_errors_nonblocking:
                raise

def send(self, data):
    bytes_sent = self._sock.send(data)
    self.bytes_written += bytes_sent
    return bytes_sent

def flush(self):
    if self._wbuf:
        buffer = &quot;&quot;.join(self._wbuf)
        self._wbuf = []
        self.sendall(buffer)

def recv(self, size):
    while True:
        try:
            data = self._sock.recv(size)
            self.bytes_read += len(data)
            return data
        except socket.error, e:
            if (e.args[0] not in socket_errors_nonblocking
                and e.args[0] not in socket_error_eintr):
                raise

if not _fileobject_uses_str_type:
    def read(self, size=-1):
        # Use max, disallow tiny reads in a loop as they are very inefficient.
        # We never leave read() with any leftover data from a new recv() call
        # in our internal buffer.
        rbufsize = max(self._rbufsize, self.default_bufsize)
        # Our use of StringIO rather than lists of string objects returned by
        # recv() minimizes memory usage and fragmentation that occurs when
        # rbufsize is large compared to the typical return value of recv().
        buf = self._rbuf
        buf.seek(0, 2)  # seek end
        if size &lt; 0:
            # Read until EOF
            self._rbuf = StringIO.StringIO()  # reset _rbuf.  we consume it via buf.
            while True:
                data = self.recv(rbufsize)
                if not data:
                    break
                buf.write(data)
            return buf.getvalue()
        else:
            # Read until size bytes or EOF seen, whichever comes first
            buf_len = buf.tell()
            if buf_len &gt;= size:
                # Already have size bytes in our buffer?  Extract and return.
                buf.seek(0)
                rv = buf.read(size)
                self._rbuf = StringIO.StringIO()
                self._rbuf.write(buf.read())
                return rv

            self._rbuf = StringIO.StringIO()  # reset _rbuf.  we consume it via buf.
            while True:
                left = size - buf_len
                # recv() will malloc the amount of memory given as its
                # parameter even though it often returns much less data
                # than that.  The returned data string is short lived
                # as we copy it into a StringIO and free it.  This avoids
                # fragmentation issues on many platforms.
                data = self.recv(left)
                if not data:
                    break
                n = len(data)
                if n == size and not buf_len:
                    # Shortcut.  Avoid buffer data copies when:
                    # - We have no data in our buffer.
                    # AND
                    # - Our call to recv returned exactly the
                    #   number of bytes we were asked to read.
                    return data
                if n == left:
                    buf.write(data)
                    del data  # explicit free
                    break
                assert n &lt;= left, &quot;recv(%d) returned %d bytes&quot; % (left, n)
                buf.write(data)
                buf_len += n
                del data  # explicit free
                #assert buf_len == buf.tell()
            return buf.getvalue()

    def readline(self, size=-1):
        buf = self._rbuf
        buf.seek(0, 2)  # seek end
        if buf.tell() &gt; 0:
            # check if we already have it in our buffer
            buf.seek(0)
            bline = buf.readline(size)
            if bline.endswith(&#39;\n&#39;) or len(bline) == size:
                self._rbuf = StringIO.StringIO()
                self._rbuf.write(buf.read())
                return bline
            del bline
        if size &lt; 0:
            # Read until \n or EOF, whichever comes first
            if self._rbufsize &lt;= 1:
                # Speed up unbuffered case
                buf.seek(0)
                buffers = [buf.read()]
                self._rbuf = StringIO.StringIO()  # reset _rbuf.  we consume it via buf.
                data = None
                recv = self.recv
                while data != &quot;\n&quot;:
                    data = recv(1)
                    if not data:
                        break
                    buffers.append(data)
                return &quot;&quot;.join(buffers)

            buf.seek(0, 2)  # seek end
            self._rbuf = StringIO.StringIO()  # reset _rbuf.  we consume it via buf.
            while True:
                data = self.recv(self._rbufsize)
                if not data:
                    break
                nl = data.find(&#39;\n&#39;)
                if nl &gt;= 0:
                    nl += 1
                    buf.write(data[:nl])
                    self._rbuf.write(data[nl:])
                    del data
                    break
                buf.write(data)
            return buf.getvalue()
        else:
            # Read until size bytes or \n or EOF seen, whichever comes first
            buf.seek(0, 2)  # seek end
            buf_len = buf.tell()
            if buf_len &gt;= size:
                buf.seek(0)
                rv = buf.read(size)
                self._rbuf = StringIO.StringIO()
                self._rbuf.write(buf.read())
                return rv
            self._rbuf = StringIO.StringIO()  # reset _rbuf.  we consume it via buf.
            while True:
                data = self.recv(self._rbufsize)
                if not data:
                    break
                left = size - buf_len
                # did we just receive a newline?
                nl = data.find(&#39;\n&#39;, 0, left)
                if nl &gt;= 0:
                    nl += 1
                    # save the excess data to _rbuf
                    self._rbuf.write(data[nl:])
                    if buf_len:
                        buf.write(data[:nl])
                        break
                    else:
                        # Shortcut.  Avoid data copy through buf when returning
                        # a substring of our first recv().
                        return data[:nl]
                n = len(data)
                if n == size and not buf_len:
                    # Shortcut.  Avoid data copy through buf when
                    # returning exactly all of our first recv().
                    return data
                if n &gt;= left:
                    buf.write(data[:left])
                    self._rbuf.write(data[left:])
                    break
                buf.write(data)
                buf_len += n
                #assert buf_len == buf.tell()
            return buf.getvalue()
else:
    def read(self, size=-1):
        if size &lt; 0:
            # Read until EOF
            buffers = [self._rbuf]
            self._rbuf = &quot;&quot;
            if self._rbufsize &lt;= 1:
                recv_size = self.default_bufsize
            else:
                recv_size = self._rbufsize

            while True:
                data = self.recv(recv_size)
                if not data:
                    break
                buffers.append(data)
            return &quot;&quot;.join(buffers)
        else:
            # Read until size bytes or EOF seen, whichever comes first
            data = self._rbuf
            buf_len = len(data)
            if buf_len &gt;= size:
                self._rbuf = data[size:]
                return data[:size]
            buffers = []
            if data:
                buffers.append(data)
            self._rbuf = &quot;&quot;
            while True:
                left = size - buf_len
                recv_size = max(self._rbufsize, left)
                data = self.recv(recv_size)
                if not data:
                    break
                buffers.append(data)
                n = len(data)
                if n &gt;= left:
                    self._rbuf = data[left:]
                    buffers[-1] = data[:left]
                    break
                buf_len += n
            return &quot;&quot;.join(buffers)

    def readline(self, size=-1):
        data = self._rbuf
        if size &lt; 0:
            # Read until \n or EOF, whichever comes first
            if self._rbufsize &lt;= 1:
                # Speed up unbuffered case
                assert data == &quot;&quot;
                buffers = []
                while data != &quot;\n&quot;:
                    data = self.recv(1)
                    if not data:
                        break
                    buffers.append(data)
                return &quot;&quot;.join(buffers)
            nl = data.find(&#39;\n&#39;)
            if nl &gt;= 0:
                nl += 1
                self._rbuf = data[nl:]
                return data[:nl]
            buffers = []
            if data:
                buffers.append(data)
            self._rbuf = &quot;&quot;
            while True:
                data = self.recv(self._rbufsize)
                if not data:
                    break
                buffers.append(data)
                nl = data.find(&#39;\n&#39;)
                if nl &gt;= 0:
                    nl += 1
                    self._rbuf = data[nl:]
                    buffers[-1] = data[:nl]
                    break
            return &quot;&quot;.join(buffers)
        else:
            # Read until size bytes or \n or EOF seen, whichever comes first
            nl = data.find(&#39;\n&#39;, 0, size)
            if nl &gt;= 0:
                nl += 1
                self._rbuf = data[nl:]
                return data[:nl]
            buf_len = len(data)
            if buf_len &gt;= size:
                self._rbuf = data[size:]
                return data[:size]
            buffers = []
            if data:
                buffers.append(data)
            self._rbuf = &quot;&quot;
            while True:
                data = self.recv(self._rbufsize)
                if not data:
                    break
                buffers.append(data)
                left = size - buf_len
                nl = data.find(&#39;\n&#39;, 0, left)
                if nl &gt;= 0:
                    nl += 1
                    self._rbuf = data[nl:]
                    buffers[-1] = data[:nl]
                    break
                n = len(data)
                if n &gt;= left:
                    self._rbuf = data[left:]
                    buffers[-1] = data[:left]
                    break
                buf_len += n
            return &quot;&quot;.join(buffers)


class _fileobject(object):
&quot;&quot;&quot;Faux file object attached to a socket object.&quot;&quot;&quot;

default_bufsize = 8192
name = &quot;&lt;socket&gt;&quot;

__slots__ = [&quot;mode&quot;, &quot;bufsize&quot;, &quot;softspace&quot;,
             # &quot;closed&quot; is a property, see below
             &quot;_sock&quot;, &quot;_rbufsize&quot;, &quot;_wbufsize&quot;, &quot;_rbuf&quot;, &quot;_wbuf&quot;, &quot;_wbuf_len&quot;,
             &quot;_close&quot;]

def __init__(self, sock, mode=&#39;rb&#39;, bufsize=-1, close=False):
    self._sock = sock
    self.mode = mode # Not actually used in this version
    if bufsize &lt; 0:
        bufsize = self.default_bufsize
    self.bufsize = bufsize
    self.softspace = False
    # _rbufsize is the suggested recv buffer size.  It is *strictly*
    # obeyed within readline() for recv calls.  If it is larger than
    # default_bufsize it will be used for recv calls within read().
    if bufsize == 0:
        self._rbufsize = 1
    elif bufsize == 1:
        self._rbufsize = self.default_bufsize
    else:
        self._rbufsize = bufsize
    self._wbufsize = bufsize
    # We use StringIO for the read buffer to avoid holding a list
    # of variously sized string objects which have been known to
    # fragment the heap due to how they are malloc()ed and often
    # realloc()ed down much smaller than their original allocation.
    self._rbuf = StringIO()
    self._wbuf = [] # A list of strings
    self._wbuf_len = 0
    self._close = close

def _getclosed(self):
    return self._sock is None
closed = property(_getclosed, doc=&quot;True if the file is closed&quot;)

def close(self):
    try:
        if self._sock:
            self.flush()
    finally:
        if self._close:
            self._sock.close()
        self._sock = None

def __del__(self):
    try:
        self.close()
    except:
        # close() may fail if __init__ didn&#39;t complete
        pass

def flush(self):
    if self._wbuf:
        data = &quot;&quot;.join(self._wbuf)
        self._wbuf = []
        self._wbuf_len = 0
        buffer_size = max(self._rbufsize, self.default_bufsize)
        data_size = len(data)
        write_offset = 0
        view = memoryview(data)
        try:
            while write_offset &lt; data_size:
                self._sock.sendall(view[write_offset:write_offset+buffer_size])
                write_offset += buffer_size
        finally:
            if write_offset &lt; data_size:
                remainder = data[write_offset:]
                del view, data  # explicit free
                self._wbuf.append(remainder)
                self._wbuf_len = len(remainder)

def fileno(self):
    return self._sock.fileno()

def write(self, data):
    data = str(data) # XXX Should really reject non-string non-buffers
    if not data:
        return
    self._wbuf.append(data)
    self._wbuf_len += len(data)
    if (self._wbufsize == 0 or
        self._wbufsize == 1 and &#39;\n&#39; in data or
        self._wbuf_len &gt;= self._wbufsize):
        self.flush()

def writelines(self, list):
    # XXX We could do better here for very long lists
    # XXX Should really reject non-string non-buffers
    lines = filter(None, map(str, list))
    self._wbuf_len += sum(map(len, lines))
    self._wbuf.extend(lines)
    if (self._wbufsize &lt;= 1 or
        self._wbuf_len &gt;= self._wbufsize):
        self.flush()

def read(self, size=-1):
    # Use max, disallow tiny reads in a loop as they are very inefficient.
    # We never leave read() with any leftover data from a new recv() call
    # in our internal buffer.
    rbufsize = max(self._rbufsize, self.default_bufsize)
    # Our use of StringIO rather than lists of string objects returned by
    # recv() minimizes memory usage and fragmentation that occurs when
    # rbufsize is large compared to the typical return value of recv().
    buf = self._rbuf
    buf.seek(0, 2)  # seek end
    if size &lt; 0:
        # Read until EOF
        self._rbuf = StringIO()  # reset _rbuf.  we consume it via buf.
        while True:
            try:
                data = self._sock.recv(rbufsize)
            except error, e:
                if e.args[0] == EINTR:
                    continue
                raise
            if not data:
                break
            buf.write(data)
        return buf.getvalue()
    else:
        # Read until size bytes or EOF seen, whichever comes first
        buf_len = buf.tell()
        if buf_len &gt;= size:
            # Already have size bytes in our buffer?  Extract and return.
            buf.seek(0)
            rv = buf.read(size)
            self._rbuf = StringIO()
            self._rbuf.write(buf.read())
            return rv

        self._rbuf = StringIO()  # reset _rbuf.  we consume it via buf.
        while True:
            left = size - buf_len
            # recv() will malloc the amount of memory given as its
            # parameter even though it often returns much less data
            # than that.  The returned data string is short lived
            # as we copy it into a StringIO and free it.  This avoids
            # fragmentation issues on many platforms.
            try:
                data = self._sock.recv(left)
            except error, e:
                if e.args[0] == EINTR:
                    continue
                raise
            if not data:
                break
            n = len(data)
            if n == size and not buf_len:
                # Shortcut.  Avoid buffer data copies when:
                # - We have no data in our buffer.
                # AND
                # - Our call to recv returned exactly the
                #   number of bytes we were asked to read.
                return data
            if n == left:
                buf.write(data)
                del data  # explicit free
                break
            assert n &lt;= left, &quot;recv(%d) returned %d bytes&quot; % (left, n)
            buf.write(data)
            buf_len += n
            del data  # explicit free
            #assert buf_len == buf.tell()
        return buf.getvalue()

def readline(self, size=-1):
    buf = self._rbuf
    buf.seek(0, 2)  # seek end
    if buf.tell() &gt; 0:
        # check if we already have it in our buffer
        buf.seek(0)
        bline = buf.readline(size)
        if bline.endswith(&#39;\n&#39;) or len(bline) == size:
            self._rbuf = StringIO()
            self._rbuf.write(buf.read())
            return bline
        del bline
    if size &lt; 0:
        # Read until \n or EOF, whichever comes first
        if self._rbufsize &lt;= 1:
            # Speed up unbuffered case
            buf.seek(0)
            buffers = [buf.read()]
            self._rbuf = StringIO()  # reset _rbuf.  we consume it via buf.
            data = None
            recv = self._sock.recv
            while True:
                try:
                    while data != &quot;\n&quot;:
                        data = recv(1)
                        if not data:
                            break
                        buffers.append(data)
                except error, e:
                    # The try..except to catch EINTR was moved outside the
                    # recv loop to avoid the per byte overhead.
                    if e.args[0] == EINTR:
                        continue
                    raise
                break
            return &quot;&quot;.join(buffers)

        buf.seek(0, 2)  # seek end
        self._rbuf = StringIO()  # reset _rbuf.  we consume it via buf.
        while True:
            try:
                data = self._sock.recv(self._rbufsize)
            except error, e:
                if e.args[0] == EINTR:
                    continue
                raise
            if not data:
                break
            nl = data.find(&#39;\n&#39;)
            if nl &gt;= 0:
                nl += 1
                buf.write(data[:nl])
                self._rbuf.write(data[nl:])
                del data
                break
            buf.write(data)
        return buf.getvalue()
    else:
        # Read until size bytes or \n or EOF seen, whichever comes first
        buf.seek(0, 2)  # seek end
        buf_len = buf.tell()
        if buf_len &gt;= size:
            buf.seek(0)
            rv = buf.read(size)
            self._rbuf = StringIO()
            self._rbuf.write(buf.read())
            return rv
        self._rbuf = StringIO()  # reset _rbuf.  we consume it via buf.
        while True:
            try:
                data = self._sock.recv(self._rbufsize)
            except error, e:
                if e.args[0] == EINTR:
                    continue
                raise
            if not data:
                break
            left = size - buf_len
            # did we just receive a newline?
            nl = data.find(&#39;\n&#39;, 0, left)
            if nl &gt;= 0:
                nl += 1
                # save the excess data to _rbuf
                self._rbuf.write(data[nl:])
                if buf_len:
                    buf.write(data[:nl])
                    break
                else:
                    # Shortcut.  Avoid data copy through buf when returning
                    # a substring of our first recv().
                    return data[:nl]
            n = len(data)
            if n == size and not buf_len:
                # Shortcut.  Avoid data copy through buf when
                # returning exactly all of our first recv().
                return data
            if n &gt;= left:
                buf.write(data[:left])
                self._rbuf.write(data[left:])
                break
            buf.write(data)
            buf_len += n
            #assert buf_len == buf.tell()
        return buf.getvalue()

def readlines(self, sizehint=0):
    total = 0
    list = []
    while True:
        line = self.readline()
        if not line:
            break
        list.append(line)
        total += len(line)
        if sizehint and total &gt;= sizehint:
            break
    return list

# Iterator protocols

def __iter__(self):
    return self

def next(self):
    line = self.readline()
    if not line:
        raise StopIteration
    return line
</pre></div>


<p><strong>HttpConnection</strong>:<br />
抽象出来的对一次client与server的一次交互过程。</p>
<div class="highlight"><pre>* _communicate:_ 处理request和respond。
* _close:_ 关闭socket，注意close那里的注释。

class HTTPConnection(object):
&quot;&quot;&quot;An HTTP connection (active socket).

server: the Server object which received this connection.
socket: the raw socket object (usually TCP) for this connection.
makefile: a fileobject class for reading from the socket.
&quot;&quot;&quot;

remote_addr = None
remote_port = None
ssl_env = None
rbufsize = DEFAULT_BUFFER_SIZE
wbufsize = DEFAULT_BUFFER_SIZE
RequestHandlerClass = HTTPRequest

def __init__(self, server, sock, makefile=CP_fileobject):
    self.server = server
    self.socket = sock
    self.rfile = makefile(sock, &quot;rb&quot;, self.rbufsize)
    self.wfile = makefile(sock, &quot;wb&quot;, self.wbufsize)
    self.requests_seen = 0

def communicate(self):
    &quot;&quot;&quot;Read each request and respond appropriately.&quot;&quot;&quot;
    request_seen = False
    try:
        while True:
            # (re)set req to None so that if something goes wrong in
            # the RequestHandlerClass constructor, the error doesn&#39;t
            # get written to the previous request.
            req = None
            req = self.RequestHandlerClass(self.server, self)

            # This order of operations should guarantee correct pipelining.
            req.parse_request()
            if self.server.stats[&#39;Enabled&#39;]:
                self.requests_seen += 1
            if not req.ready:
                # Something went wrong in the parsing (and the server has
                # probably already made a simple_response). Return and
                # let the conn close.
                return

            request_seen = True
            req.respond()
            if req.close_connection:
                return
    except socket.error, e:
        errnum = e.args[0]
        # sadly SSL sockets return a different (longer) time out string
        if errnum == &#39;timed out&#39; or errnum == &#39;The read operation timed out&#39;:
            # Don&#39;t error if we&#39;re between requests; only error
            # if 1) no request has been started at all, or 2) we&#39;re
            # in the middle of a request.
            # See http://www.cherrypy.org/ticket/853
            if (not request_seen) or (req and req.started_request):
                # Don&#39;t bother writing the 408 if the response
                # has already started being written.
                if req and not req.sent_headers:
                    try:
                        req.simple_response(&quot;408 Request Timeout&quot;)
                    except FatalSSLAlert:
                        # Close the connection.
                        return
        elif errnum not in socket_errors_to_ignore:
            if req and not req.sent_headers:
                try:
                    req.simple_response(&quot;500 Internal Server Error&quot;,
                                        format_exc())
                except FatalSSLAlert:
                    # Close the connection.
                    return
        return
    except (KeyboardInterrupt, SystemExit):
        raise
    except FatalSSLAlert:
        # Close the connection.
        return
    except NoSSLError:
        if req and not req.sent_headers:
            # Unwrap our wfile
            self.wfile = CP_fileobject(self.socket._sock, &quot;wb&quot;, self.wbufsize)
            req.simple_response(&quot;400 Bad Request&quot;,
                &quot;The client sent a plain HTTP request, but &quot;
                &quot;this server only speaks HTTPS on this port.&quot;)
            self.linger = True
    except Exception:
        if req and not req.sent_headers:
            try:
                req.simple_response(&quot;500 Internal Server Error&quot;, format_exc())
            except FatalSSLAlert:
                # Close the connection.
                return

linger = False

def close(self):
    &quot;&quot;&quot;Close the socket underlying this connection.&quot;&quot;&quot;
    self.rfile.close()

    if not self.linger:
        # Python&#39;s socket module does NOT call close on the kernel socket
        # when you call socket.close(). We do so manually here because we
        # want this server to send a FIN TCP segment immediately. Note this
        # must be called *before* calling socket.close(), because the latter
        # drops its reference to the kernel socket.
        if hasattr(self.socket, &#39;_sock&#39;):
            self.socket._sock.close()
        self.socket.close()
    else:
        # On the other hand, sometimes we want to hang around for a bit
        # to make sure the client has a chance to read our entire
        # response. Skipping the close() calls here delays the FIN
        # packet until the socket object is garbage-collected later.
        # Someday, perhaps, we&#39;ll do the full lingering_close that
        # Apache does, but not today.
        pass
</pre></div>


<p><strong>HttpServer</strong>:  </p>
<div class="highlight"><pre>* <span class="n">一些对应server的属性</span>(<span class="n">bind_addr</span> <span class="n">严格按照IP4</span> <span class="o">or</span> <span class="n">IP6传元组进来</span>)，<span class="n">有很好的注释</span>，<span class="n">我就不再赘述</span>。
* <span class="n">_clear_stats:_</span> <span class="n">server维护了一张状态表</span>，<span class="n">此方法用来清空server的这张状态表</span>。
* <span class="n">_runtime:_</span> <span class="n">返回server到目前运行了多少时间</span>。
* <span class="n">_bind:_</span> <span class="n">根据family</span>, <span class="n">addr</span>, <span class="n">type</span>, <span class="n">proto等bind</span> <span class="n">socket</span>。 <span class="n">这个API很有用</span>，<span class="k">self</span>.<span class="n">socket</span>.<span class="n">setsockopt</span>(<span class="n">socket</span>.<span class="n">SOL_SOCKET</span>, <span class="n">socket</span>.<span class="n">SO_REUSEADDR</span>, <span class="mi">1</span>)<span class="n">可以重用WAIT的socket</span>。  
* <span class="n">_tick:_</span> <span class="n">accept一次</span>。<span class="n">根据server</span>，<span class="n">刚建立的socket</span>，<span class="n">和makefile创建HttpConnect处理req</span>，<span class="n">并放进worker中去并行处理</span>。  
* <span class="n">_start:_</span> <span class="n">forever</span> <span class="n">the</span> <span class="n">server</span>. （<span class="n">这里面</span>，<span class="n">其实穿插了许多的https相关的处理</span>，<span class="n">待看了ssl_adapter之后加上</span>。）<span class="n">开始listen</span>，<span class="n">启动线程池</span>，<span class="n">然后不断的轮询accept</span>。<span class="n">这里需要注意</span><span class="nv">&amp;学习的点就是如何close</span> <span class="n">safely</span>。
* <span class="n">_stop:_</span> *<span class="n">Gracefully</span> <span class="n">shutdown</span> <span class="n">a</span> <span class="n">server</span> <span class="n">that</span> <span class="k">is</span> <span class="n">serving</span> <span class="n">forever</span>.* <span class="n">顺序是</span>，<span class="n">首先把轮询条件mark掉</span>，<span class="n">然后close掉server的socket</span>，<span class="n">最后把线程池的资源都释放掉</span>。

<span class="k">class</span> <span class="n">HTTPServer</span>(<span class="n">object</span>):
<span class="s">&quot;&quot;&quot;An HTTP server.&quot;&quot;&quot;</span>

<span class="n">_bind_addr</span> = <span class="s">&quot;127.0.0.1&quot;</span>
<span class="n">_interrupt</span> = <span class="n">None</span>

<span class="n">gateway</span> = <span class="n">None</span>
<span class="s">&quot;&quot;&quot;A Gateway instance.&quot;&quot;&quot;</span>

<span class="n">minthreads</span> = <span class="n">None</span>
<span class="s">&quot;&quot;&quot;The minimum number of worker threads to create (default 10).&quot;&quot;&quot;</span>

<span class="n">maxthreads</span> = <span class="n">None</span>
<span class="s">&quot;&quot;&quot;The maximum number of worker threads to create (default -1 = no limit).&quot;&quot;&quot;</span>

<span class="n">server_name</span> = <span class="n">None</span>
<span class="s">&quot;&quot;&quot;The name of the server; defaults to socket.gethostname().&quot;&quot;&quot;</span>

<span class="n">protocol</span> = <span class="s">&quot;HTTP/1.1&quot;</span>
<span class="s">&quot;&quot;&quot;The version string to write in the Status-Line of all HTTP responses.</span>

<span class="s">For example, &quot;</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="s">&quot; is the default. This also limits the supported</span>
<span class="s">features used in the response.&quot;&quot;&quot;</span>

<span class="n">request_queue_size</span> = <span class="mi">5</span>
<span class="s">&quot;&quot;&quot;The &#39;backlog&#39; arg to socket.listen(); max queued connections (default 5).&quot;&quot;&quot;</span>

<span class="n">shutdown_timeout</span> = <span class="mi">5</span>
<span class="s">&quot;&quot;&quot;The total time, in seconds, to wait for worker threads to cleanly exit.&quot;&quot;&quot;</span>

<span class="n">timeout</span> = <span class="mi">10</span>
<span class="s">&quot;&quot;&quot;The timeout in seconds for accepted connections (default 10).&quot;&quot;&quot;</span>

<span class="n">version</span> = <span class="s">&quot;CherryPy/3.2.0&quot;</span>
<span class="s">&quot;&quot;&quot;A version string for the HTTPServer.&quot;&quot;&quot;</span>

<span class="n">software</span> = <span class="n">None</span>
<span class="s">&quot;&quot;&quot;The value to set for the SERVER_SOFTWARE entry in the WSGI environ.</span>

<span class="s">If None, this defaults to ``&#39;%s Server&#39; % self.version``.&quot;&quot;&quot;</span>

<span class="n">ready</span> = <span class="nb">False</span>
<span class="s">&quot;&quot;&quot;An internal flag which marks whether the socket is accepting connections.&quot;&quot;&quot;</span>

<span class="n">max_request_header_size</span> = <span class="mi">0</span>
<span class="s">&quot;&quot;&quot;The maximum size, in bytes, for request headers, or 0 for no limit.&quot;&quot;&quot;</span>

<span class="n">max_request_body_size</span> = <span class="mi">0</span>
<span class="s">&quot;&quot;&quot;The maximum size, in bytes, for request bodies, or 0 for no limit.&quot;&quot;&quot;</span>

<span class="n">nodelay</span> = <span class="nb">True</span>
<span class="s">&quot;&quot;&quot;If True (the default since 3.1), sets the TCP_NODELAY socket option.&quot;&quot;&quot;</span>

<span class="n">ConnectionClass</span> = <span class="n">HTTPConnection</span>
<span class="s">&quot;&quot;&quot;The class to use for handling HTTP connections.&quot;&quot;&quot;</span>

<span class="n">ssl_adapter</span> = <span class="n">None</span>
<span class="s">&quot;&quot;&quot;An instance of SSLAdapter (or a subclass).</span>

<span class="s">You must have the corresponding SSL driver library installed.&quot;&quot;&quot;</span>

<span class="n">def</span> <span class="n">__init__</span>(<span class="k">self</span>, <span class="n">bind_addr</span>, <span class="n">gateway</span>, <span class="n">minthreads</span>=<span class="mi">10</span>, <span class="n">maxthreads</span>=-<span class="mi">1</span>,
             <span class="n">server_name</span>=<span class="n">None</span>):
    <span class="k">self</span>.<span class="n">bind_addr</span> = <span class="n">bind_addr</span>
    <span class="k">self</span>.<span class="n">gateway</span> = <span class="n">gateway</span>

    <span class="k">self</span>.<span class="n">requests</span> = <span class="n">ThreadPool</span>(<span class="k">self</span>, <span class="nb">min</span>=<span class="n">minthreads</span> <span class="o">or</span> <span class="mi">1</span>, <span class="nb">max</span>=<span class="n">maxthreads</span>)

    <span class="k">if</span> <span class="nb">not</span> <span class="n">server_name:</span>
        <span class="n">server_name</span> = <span class="n">socket</span>.<span class="n">gethostname</span>()
    <span class="k">self</span>.<span class="n">server_name</span> = <span class="n">server_name</span>
    <span class="k">self</span>.<span class="n">clear_stats</span>()

<span class="n">def</span> <span class="n">clear_stats</span>(<span class="k">self</span>):
    <span class="k">self</span>.<span class="n">_start_time</span> = <span class="n">None</span>
    <span class="k">self</span>.<span class="n">_run_time</span> = <span class="mi">0</span>
    <span class="k">self</span>.<span class="n">stats</span> = {
        <span class="s">&#39;Enabled&#39;</span>: <span class="nb">False</span>,
        <span class="s">&#39;Bind Address&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: <span class="n">repr</span>(<span class="k">self</span>.<span class="n">bind_addr</span>),
        <span class="s">&#39;Run time&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: (<span class="nb">not</span> <span class="o">s</span>[<span class="s">&#39;Enabled&#39;</span>]) <span class="o">and</span> <span class="mi">0</span> <span class="o">or</span> <span class="k">self</span>.<span class="n">runtime</span>(),
        <span class="s">&#39;Accepts&#39;</span>: <span class="mi">0</span>,
        <span class="s">&#39;Accepts/sec&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: <span class="o">s</span>[<span class="s">&#39;Accepts&#39;</span>] / <span class="k">self</span>.<span class="n">runtime</span>(),
        <span class="s">&#39;Queue&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: <span class="n">getattr</span>(<span class="k">self</span>.<span class="n">requests</span>, <span class="s">&quot;qsize&quot;</span>, <span class="n">None</span>),
        <span class="s">&#39;Threads&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: <span class="n">len</span>(<span class="n">getattr</span>(<span class="k">self</span>.<span class="n">requests</span>, <span class="s">&quot;_threads&quot;</span>, [])),
        <span class="s">&#39;Threads Idle&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: <span class="n">getattr</span>(<span class="k">self</span>.<span class="n">requests</span>, <span class="s">&quot;idle&quot;</span>, <span class="n">None</span>),
        <span class="s">&#39;Socket Errors&#39;</span>: <span class="mi">0</span>,
        <span class="s">&#39;Requests&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: (<span class="nb">not</span> <span class="o">s</span>[<span class="s">&#39;Enabled&#39;</span>]) <span class="o">and</span> <span class="mi">0</span> <span class="o">or</span> <span class="nb">sum</span>([<span class="n">w</span>[<span class="s">&#39;Requests&#39;</span>](<span class="n">w</span>) <span class="k">for</span> <span class="n">w</span>
                                   <span class="n">in</span> <span class="o">s</span>[<span class="s">&#39;Worker Threads&#39;</span>].<span class="nb">values</span>()], <span class="mi">0</span>),
        <span class="s">&#39;Bytes Read&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: (<span class="nb">not</span> <span class="o">s</span>[<span class="s">&#39;Enabled&#39;</span>]) <span class="o">and</span> <span class="mi">0</span> <span class="o">or</span> <span class="nb">sum</span>([<span class="n">w</span>[<span class="s">&#39;Bytes Read&#39;</span>](<span class="n">w</span>) <span class="k">for</span> <span class="n">w</span>
                                     <span class="n">in</span> <span class="o">s</span>[<span class="s">&#39;Worker Threads&#39;</span>].<span class="nb">values</span>()], <span class="mi">0</span>),
        <span class="s">&#39;Bytes Written&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: (<span class="nb">not</span> <span class="o">s</span>[<span class="s">&#39;Enabled&#39;</span>]) <span class="o">and</span> <span class="mi">0</span> <span class="o">or</span> <span class="nb">sum</span>([<span class="n">w</span>[<span class="s">&#39;Bytes Written&#39;</span>](<span class="n">w</span>) <span class="k">for</span> <span class="n">w</span>
                                        <span class="n">in</span> <span class="o">s</span>[<span class="s">&#39;Worker Threads&#39;</span>].<span class="nb">values</span>()], <span class="mi">0</span>),
        <span class="s">&#39;Work Time&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: (<span class="nb">not</span> <span class="o">s</span>[<span class="s">&#39;Enabled&#39;</span>]) <span class="o">and</span> <span class="mi">0</span> <span class="o">or</span> <span class="nb">sum</span>([<span class="n">w</span>[<span class="s">&#39;Work Time&#39;</span>](<span class="n">w</span>) <span class="k">for</span> <span class="n">w</span>
                                     <span class="n">in</span> <span class="o">s</span>[<span class="s">&#39;Worker Threads&#39;</span>].<span class="nb">values</span>()], <span class="mi">0</span>),
        <span class="s">&#39;Read Throughput&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: (<span class="nb">not</span> <span class="o">s</span>[<span class="s">&#39;Enabled&#39;</span>]) <span class="o">and</span> <span class="mi">0</span> <span class="o">or</span> <span class="nb">sum</span>(
            [<span class="n">w</span>[<span class="s">&#39;Bytes Read&#39;</span>](<span class="n">w</span>) / (<span class="n">w</span>[<span class="s">&#39;Work Time&#39;</span>](<span class="n">w</span>) <span class="o">or</span> <span class="mf">1e-6</span>)
             <span class="k">for</span> <span class="n">w</span> <span class="n">in</span> <span class="o">s</span>[<span class="s">&#39;Worker Threads&#39;</span>].<span class="nb">values</span>()], <span class="mi">0</span>),
        <span class="s">&#39;Write Throughput&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: (<span class="nb">not</span> <span class="o">s</span>[<span class="s">&#39;Enabled&#39;</span>]) <span class="o">and</span> <span class="mi">0</span> <span class="o">or</span> <span class="nb">sum</span>(
            [<span class="n">w</span>[<span class="s">&#39;Bytes Written&#39;</span>](<span class="n">w</span>) / (<span class="n">w</span>[<span class="s">&#39;Work Time&#39;</span>](<span class="n">w</span>) <span class="o">or</span> <span class="mf">1e-6</span>)
             <span class="k">for</span> <span class="n">w</span> <span class="n">in</span> <span class="o">s</span>[<span class="s">&#39;Worker Threads&#39;</span>].<span class="nb">values</span>()], <span class="mi">0</span>),
        <span class="s">&#39;Worker Threads&#39;</span>: {},
        }
    <span class="n">logging</span>.<span class="n">statistics</span>[<span class="s">&quot;CherryPy HTTPServer %d&quot;</span> % <span class="n">id</span>(<span class="k">self</span>)] = <span class="k">self</span>.<span class="n">stats</span>

<span class="n">def</span> <span class="n">runtime</span>(<span class="k">self</span>):
    <span class="k">if</span> <span class="k">self</span>.<span class="n">_start_time</span> <span class="k">is</span> <span class="n">None:</span>
        <span class="k">return</span> <span class="k">self</span>.<span class="n">_run_time</span>
    <span class="n">else:</span>
        <span class="k">return</span> <span class="k">self</span>.<span class="n">_run_time</span> + (<span class="nb">time</span>.<span class="nb">time</span>() - <span class="k">self</span>.<span class="n">_start_time</span>)

<span class="n">def</span> <span class="n">__str__</span>(<span class="k">self</span>):
    <span class="k">return</span> <span class="s">&quot;%s.%s(%r)&quot;</span> % (<span class="k">self</span>.<span class="n">__module__</span>, <span class="k">self</span>.<span class="n">__class__</span>.<span class="n">__name__</span>,
                          <span class="k">self</span>.<span class="n">bind_addr</span>)

<span class="n">def</span> <span class="n">_get_bind_addr</span>(<span class="k">self</span>):
    <span class="k">return</span> <span class="k">self</span>.<span class="n">_bind_addr</span>
<span class="n">def</span> <span class="n">_set_bind_addr</span>(<span class="k">self</span>, <span class="nb">value</span>):
    <span class="k">if</span> <span class="n">isinstance</span>(<span class="nb">value</span>, <span class="n">tuple</span>) <span class="o">and</span> <span class="nb">value</span>[<span class="mi">0</span>] <span class="n">in</span> (<span class="s">&#39;&#39;</span>, <span class="n">None</span>):
        <span class="c-Singleline"># Despite the socket module docs, using &#39;&#39; does not</span>
        <span class="c-Singleline"># allow AI_PASSIVE to work. Passing None instead</span>
        <span class="c-Singleline"># returns &#39;0.0.0.0&#39; like we want. In other words:</span>
        <span class="c-Singleline">#     host    AI_PASSIVE     result</span>
        <span class="c-Singleline">#      &#39;&#39;         Y         192.168.x.y</span>
        <span class="c-Singleline">#      &#39;&#39;         N         192.168.x.y</span>
        <span class="c-Singleline">#     None        Y         0.0.0.0</span>
        <span class="c-Singleline">#     None        N         127.0.0.1</span>
        <span class="c-Singleline"># But since you can get the same effect with an explicit</span>
        <span class="c-Singleline"># &#39;0.0.0.0&#39;, we deny both the empty string and None as values.</span>
        <span class="n">raise</span> <span class="n">ValueError</span>(<span class="s">&quot;Host values of &#39;&#39; or None are not allowed. &quot;</span>
                         <span class="s">&quot;Use &#39;0.0.0.0&#39; (IPv4) or &#39;::&#39; (IPv6) instead &quot;</span>
                         <span class="s">&quot;to listen on all active interfaces.&quot;</span>)
    <span class="k">self</span>.<span class="n">_bind_addr</span> = <span class="nb">value</span>
<span class="n">bind_addr</span> = <span class="n">property</span>(<span class="n">_get_bind_addr</span>, <span class="n">_set_bind_addr</span>,
    <span class="n">doc</span>=<span class="s">&quot;&quot;&quot;The interface on which to listen for connections.</span>

<span class="s">    For TCP sockets, a (host, port) tuple. Host values may be any IPv4</span>
<span class="s">    or IPv6 address, or any valid hostname. The string &#39;localhost&#39; is a</span>
<span class="s">    synonym for &#39;127.0.0.1&#39; (or &#39;::1&#39;, if your hosts file prefers IPv6).</span>
<span class="s">    The string &#39;0.0.0.0&#39; is a special IPv4 entry meaning &quot;</span><span class="nb">any</span> <span class="n">active</span>
    <span class="n">interface</span><span class="s">&quot; (INADDR_ANY), and &#39;::&#39; is the similar IN6ADDR_ANY for</span>
<span class="s">    IPv6. The empty string or None are not allowed.</span>

<span class="s">    For UNIX sockets, supply the filename as a string.&quot;&quot;&quot;</span>)

<span class="n">def</span> <span class="n">start</span>(<span class="k">self</span>):
    <span class="s">&quot;&quot;&quot;Run the server forever.&quot;&quot;&quot;</span>
    <span class="c-Singleline"># We don&#39;t have to trap KeyboardInterrupt or SystemExit here,</span>
    <span class="c-Singleline"># because cherrpy.server already does so, calling self.stop() for us.</span>
    <span class="c-Singleline"># If you&#39;re using this server with another framework, you should</span>
    <span class="c-Singleline"># trap those exceptions in whatever code block calls start().</span>
    <span class="k">self</span>.<span class="n">_interrupt</span> = <span class="n">None</span>

    <span class="k">if</span> <span class="k">self</span>.<span class="n">software</span> <span class="k">is</span> <span class="n">None:</span>
        <span class="k">self</span>.<span class="n">software</span> = <span class="s">&quot;%s Server&quot;</span> % <span class="k">self</span>.<span class="n">version</span>

    <span class="c-Singleline"># SSL backward compatibility</span>
    <span class="k">if</span> (<span class="k">self</span>.<span class="n">ssl_adapter</span> <span class="k">is</span> <span class="n">None</span> <span class="o">and</span>
        <span class="n">getattr</span>(<span class="k">self</span>, <span class="s">&#39;ssl_certificate&#39;</span>, <span class="n">None</span>) <span class="o">and</span>
        <span class="n">getattr</span>(<span class="k">self</span>, <span class="s">&#39;ssl_private_key&#39;</span>, <span class="n">None</span>)):
        <span class="n">warnings</span>.<span class="k">warn</span>(
                <span class="s">&quot;SSL attributes are deprecated in CherryPy 3.2, and will &quot;</span>
                <span class="s">&quot;be removed in CherryPy 3.3. Use an ssl_adapter attribute &quot;</span>
                <span class="s">&quot;instead.&quot;</span>,
                <span class="n">DeprecationWarning</span>
            )
        <span class="n">try:</span>
            <span class="nb">from</span> <span class="n">cherrypy</span>.<span class="n">wsgiserver</span>.<span class="n">ssl_pyopenssl</span> <span class="n">import</span> <span class="n">pyOpenSSLAdapter</span>
        <span class="n">except</span> <span class="n">ImportError:</span>
            <span class="nb">pass</span>
        <span class="n">else:</span>
            <span class="k">self</span>.<span class="n">ssl_adapter</span> = <span class="n">pyOpenSSLAdapter</span>(
                <span class="k">self</span>.<span class="n">ssl_certificate</span>, <span class="k">self</span>.<span class="n">ssl_private_key</span>,
                <span class="n">getattr</span>(<span class="k">self</span>, <span class="s">&#39;ssl_certificate_chain&#39;</span>, <span class="n">None</span>))

    <span class="c-Singleline"># Select the appropriate socket</span>
    <span class="k">if</span> <span class="n">isinstance</span>(<span class="k">self</span>.<span class="n">bind_addr</span>, <span class="n">basestring</span>):
        <span class="c-Singleline"># AF_UNIX socket</span>

        <span class="c-Singleline"># So we can reuse the socket...</span>
        <span class="n">try:</span> <span class="n">os</span>.<span class="nb">unlink</span>(<span class="k">self</span>.<span class="n">bind_addr</span>)
        <span class="n">except:</span> <span class="nb">pass</span>

        <span class="c-Singleline"># So everyone can access the socket...</span>
        <span class="n">try:</span> <span class="n">os</span>.<span class="nb">chmod</span>(<span class="k">self</span>.<span class="n">bind_addr</span>, <span class="mo">0777</span>)
        <span class="n">except:</span> <span class="nb">pass</span>

        <span class="n">info</span> = [(<span class="n">socket</span>.<span class="n">AF_UNIX</span>, <span class="n">socket</span>.<span class="n">SOCK_STREAM</span>, <span class="mi">0</span>, <span class="s">&quot;&quot;</span>, <span class="k">self</span>.<span class="n">bind_addr</span>)]
    <span class="n">else:</span>
        <span class="c-Singleline"># AF_INET or AF_INET6 socket</span>
        <span class="c-Singleline"># Get the correct address family for our host (allows IPv6 addresses)</span>
        <span class="n">host</span>, <span class="n">port</span> = <span class="k">self</span>.<span class="n">bind_addr</span>
        <span class="n">try:</span>
            <span class="n">info</span> = <span class="n">socket</span>.<span class="n">getaddrinfo</span>(<span class="n">host</span>, <span class="n">port</span>, <span class="n">socket</span>.<span class="n">AF_UNSPEC</span>,
                                      <span class="n">socket</span>.<span class="n">SOCK_STREAM</span>, <span class="mi">0</span>, <span class="n">socket</span>.<span class="n">AI_PASSIVE</span>)
        <span class="n">except</span> <span class="n">socket</span>.<span class="n">gaierror:</span>
            <span class="k">if</span> <span class="s">&#39;:&#39;</span> <span class="n">in</span> <span class="k">self</span>.<span class="n">bind_addr</span>[<span class="mi">0</span>]:
                <span class="n">info</span> = [(<span class="n">socket</span>.<span class="n">AF_INET6</span>, <span class="n">socket</span>.<span class="n">SOCK_STREAM</span>,
                         <span class="mi">0</span>, <span class="s">&quot;&quot;</span>, <span class="k">self</span>.<span class="n">bind_addr</span> + (<span class="mi">0</span>, <span class="mi">0</span>))]
            <span class="n">else:</span>
                <span class="n">info</span> = [(<span class="n">socket</span>.<span class="n">AF_INET</span>, <span class="n">socket</span>.<span class="n">SOCK_STREAM</span>,
                         <span class="mi">0</span>, <span class="s">&quot;&quot;</span>, <span class="k">self</span>.<span class="n">bind_addr</span>)]

    <span class="k">self</span>.<span class="n">socket</span> = <span class="n">None</span>
    <span class="n">msg</span> = <span class="s">&quot;No socket could be created&quot;</span>
    <span class="k">for</span> <span class="n">res</span> <span class="n">in</span> <span class="n">info:</span>
        <span class="n">af</span>, <span class="n">socktype</span>, <span class="k">proto</span>, <span class="n">canonname</span>, <span class="n">sa</span> = <span class="n">res</span>
        <span class="n">try:</span>
            <span class="k">self</span>.<span class="n">bind</span>(<span class="n">af</span>, <span class="n">socktype</span>, <span class="k">proto</span>)
        <span class="n">except</span> <span class="n">socket</span>.<span class="n">error:</span>
            <span class="k">if</span> <span class="k">self</span>.<span class="n">socket:</span>
                <span class="k">self</span>.<span class="n">socket</span>.<span class="nb">close</span>()
            <span class="k">self</span>.<span class="n">socket</span> = <span class="n">None</span>
            <span class="k">continue</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="nb">not</span> <span class="k">self</span>.<span class="n">socket:</span>
        <span class="n">raise</span> <span class="n">socket</span>.<span class="n">error</span>(<span class="n">msg</span>)

    <span class="c-Singleline"># Timeout so KeyboardInterrupt can be caught on Win32</span>
    <span class="k">self</span>.<span class="n">socket</span>.<span class="n">settimeout</span>(<span class="mi">1</span>)
    <span class="k">self</span>.<span class="n">socket</span>.<span class="n">listen</span>(<span class="k">self</span>.<span class="n">request_queue_size</span>)

    <span class="c-Singleline"># Create worker threads</span>
    <span class="k">self</span>.<span class="n">requests</span>.<span class="n">start</span>()

    <span class="k">self</span>.<span class="n">ready</span> = <span class="nb">True</span>
    <span class="k">self</span>.<span class="n">_start_time</span> = <span class="nb">time</span>.<span class="nb">time</span>()
    <span class="k">while</span> <span class="k">self</span>.<span class="n">ready:</span>
        <span class="k">self</span>.<span class="n">tick</span>()
        <span class="k">if</span> <span class="k">self</span>.<span class="n">interrupt:</span>
            <span class="k">while</span> <span class="k">self</span>.<span class="n">interrupt</span> <span class="k">is</span> <span class="n">True:</span>
                <span class="c-Singleline"># Wait for self.stop() to complete. See _set_interrupt.</span>
                <span class="nb">time</span>.<span class="nb">sleep</span>(<span class="mf">0.1</span>)
            <span class="k">if</span> <span class="k">self</span>.<span class="n">interrupt:</span>
                <span class="n">raise</span> <span class="k">self</span>.<span class="n">interrupt</span>

<span class="n">def</span> <span class="n">bind</span>(<span class="k">self</span>, <span class="n">family</span>, <span class="n">type</span>, <span class="k">proto</span>=<span class="mi">0</span>):
    <span class="s">&quot;&quot;&quot;Create (or recreate) the actual socket object.&quot;&quot;&quot;</span>
    <span class="k">self</span>.<span class="n">socket</span> = <span class="n">socket</span>.<span class="n">socket</span>(<span class="n">family</span>, <span class="n">type</span>, <span class="k">proto</span>)
    <span class="n">prevent_socket_inheritance</span>(<span class="k">self</span>.<span class="n">socket</span>)
    <span class="k">self</span>.<span class="n">socket</span>.<span class="n">setsockopt</span>(<span class="n">socket</span>.<span class="n">SOL_SOCKET</span>, <span class="n">socket</span>.<span class="n">SO_REUSEADDR</span>, <span class="mi">1</span>)
    <span class="k">if</span> <span class="k">self</span>.<span class="n">nodelay</span> <span class="o">and</span> <span class="nb">not</span> <span class="n">isinstance</span>(<span class="k">self</span>.<span class="n">bind_addr</span>, <span class="n">str</span>):
        <span class="k">self</span>.<span class="n">socket</span>.<span class="n">setsockopt</span>(<span class="n">socket</span>.<span class="n">IPPROTO_TCP</span>, <span class="n">socket</span>.<span class="n">TCP_NODELAY</span>, <span class="mi">1</span>)

    <span class="k">if</span> <span class="k">self</span>.<span class="n">ssl_adapter</span> <span class="k">is</span> <span class="nb">not</span> <span class="n">None:</span>
        <span class="k">self</span>.<span class="n">socket</span> = <span class="k">self</span>.<span class="n">ssl_adapter</span>.<span class="n">bind</span>(<span class="k">self</span>.<span class="n">socket</span>)

    <span class="c-Singleline"># If listening on the IPV6 any address (&#39;::&#39; = IN6ADDR_ANY),</span>
    <span class="c-Singleline"># activate dual-stack. See http://www.cherrypy.org/ticket/871.</span>
    <span class="k">if</span> (<span class="n">hasattr</span>(<span class="n">socket</span>, <span class="s">&#39;AF_INET6&#39;</span>) <span class="o">and</span> <span class="n">family</span> == <span class="n">socket</span>.<span class="n">AF_INET6</span>
        <span class="o">and</span> <span class="k">self</span>.<span class="n">bind_addr</span>[<span class="mi">0</span>] <span class="n">in</span> (<span class="s">&#39;::&#39;</span>, <span class="s">&#39;::0&#39;</span>, <span class="s">&#39;::0.0.0.0&#39;</span>)):
        <span class="n">try:</span>
            <span class="k">self</span>.<span class="n">socket</span>.<span class="n">setsockopt</span>(<span class="n">socket</span>.<span class="n">IPPROTO_IPV6</span>, <span class="n">socket</span>.<span class="n">IPV6_V6ONLY</span>, <span class="mi">0</span>)
        <span class="n">except</span> (<span class="n">AttributeError</span>, <span class="n">socket</span>.<span class="n">error</span>):
            <span class="c-Singleline"># Apparently, the socket option is not available in</span>
            <span class="c-Singleline"># this machine&#39;s TCP stack</span>
            <span class="nb">pass</span>

    <span class="k">self</span>.<span class="n">socket</span>.<span class="n">bind</span>(<span class="k">self</span>.<span class="n">bind_addr</span>)

<span class="n">def</span> <span class="n">tick</span>(<span class="k">self</span>):
    <span class="s">&quot;&quot;&quot;Accept a new connection and put it on the Queue.&quot;&quot;&quot;</span>
    <span class="n">try:</span>
        <span class="o">s</span>, <span class="n">addr</span> = <span class="k">self</span>.<span class="n">socket</span>.<span class="n">accept</span>()
        <span class="k">if</span> <span class="k">self</span>.<span class="n">stats</span>[<span class="s">&#39;Enabled&#39;</span>]:
            <span class="k">self</span>.<span class="n">stats</span>[<span class="s">&#39;Accepts&#39;</span>] += <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">not</span> <span class="k">self</span>.<span class="n">ready:</span>
            <span class="k">return</span>

        <span class="n">prevent_socket_inheritance</span>(<span class="o">s</span>)
        <span class="k">if</span> <span class="n">hasattr</span>(<span class="o">s</span>, <span class="s">&#39;settimeout&#39;</span>):
            <span class="o">s</span>.<span class="n">settimeout</span>(<span class="k">self</span>.<span class="n">timeout</span>)

        <span class="n">makefile</span> = <span class="n">CP_fileobject</span>
        <span class="n">ssl_env</span> = {}
        <span class="c-Singleline"># if ssl cert and key are set, we try to be a secure HTTP server</span>
        <span class="k">if</span> <span class="k">self</span>.<span class="n">ssl_adapter</span> <span class="k">is</span> <span class="nb">not</span> <span class="n">None:</span>
            <span class="n">try:</span>
                <span class="o">s</span>, <span class="n">ssl_env</span> = <span class="k">self</span>.<span class="n">ssl_adapter</span>.<span class="nb">wrap</span>(<span class="o">s</span>)
            <span class="n">except</span> <span class="n">NoSSLError:</span>
                <span class="n">msg</span> = (<span class="s">&quot;The client sent a plain HTTP request, but &quot;</span>
                       <span class="s">&quot;this server only speaks HTTPS on this port.&quot;</span>)
                <span class="nb">buf</span> = [<span class="s">&quot;%s 400 Bad Request\r\n&quot;</span> % <span class="k">self</span>.<span class="n">protocol</span>,
                       <span class="s">&quot;Content-Length: %s\r\n&quot;</span> % <span class="n">len</span>(<span class="n">msg</span>),
                       <span class="s">&quot;Content-Type: text/plain\r\n\r\n&quot;</span>,
                       <span class="n">msg</span>]

                <span class="n">wfile</span> = <span class="n">CP_fileobject</span>(<span class="o">s</span>, <span class="s">&quot;wb&quot;</span>, <span class="n">DEFAULT_BUFFER_SIZE</span>)
                <span class="n">try:</span>
                    <span class="n">wfile</span>.<span class="n">sendall</span>(<span class="s">&quot;&quot;</span>.<span class="nb">join</span>(<span class="nb">buf</span>))
                <span class="n">except</span> <span class="n">socket</span>.<span class="n">error</span>, <span class="o">x</span>:
                    <span class="k">if</span> <span class="o">x</span>.<span class="n">args</span>[<span class="mi">0</span>] <span class="nb">not</span> <span class="n">in</span> <span class="n">socket_errors_to_ignore:</span>
                        <span class="n">raise</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">not</span> <span class="o">s</span>:
                <span class="k">return</span>
            <span class="n">makefile</span> = <span class="k">self</span>.<span class="n">ssl_adapter</span>.<span class="n">makefile</span>
            <span class="c-Singleline"># Re-apply our timeout since we may have a new socket object</span>
            <span class="k">if</span> <span class="n">hasattr</span>(<span class="o">s</span>, <span class="s">&#39;settimeout&#39;</span>):
                <span class="o">s</span>.<span class="n">settimeout</span>(<span class="k">self</span>.<span class="n">timeout</span>)

        <span class="n">conn</span> = <span class="k">self</span>.<span class="n">ConnectionClass</span>(<span class="k">self</span>, <span class="o">s</span>, <span class="n">makefile</span>)

        <span class="k">if</span> <span class="nb">not</span> <span class="n">isinstance</span>(<span class="k">self</span>.<span class="n">bind_addr</span>, <span class="n">basestring</span>):
            <span class="c-Singleline"># optional values</span>
            <span class="c-Singleline"># Until we do DNS lookups, omit REMOTE_HOST</span>
            <span class="k">if</span> <span class="n">addr</span> <span class="k">is</span> <span class="n">None:</span> <span class="c-Singleline"># sometimes this can happen</span>
                <span class="c-Singleline"># figure out if AF_INET or AF_INET6.</span>
                <span class="k">if</span> <span class="n">len</span>(<span class="o">s</span>.<span class="n">getsockname</span>()) == <span class="mi">2</span>:
                    <span class="c-Singleline"># AF_INET</span>
                    <span class="n">addr</span> = (<span class="s">&#39;0.0.0.0&#39;</span>, <span class="mi">0</span>)
                <span class="n">else:</span>
                    <span class="c-Singleline"># AF_INET6</span>
                    <span class="n">addr</span> = (<span class="s">&#39;::&#39;</span>, <span class="mi">0</span>)
            <span class="n">conn</span>.<span class="n">remote_addr</span> = <span class="n">addr</span>[<span class="mi">0</span>]
            <span class="n">conn</span>.<span class="n">remote_port</span> = <span class="n">addr</span>[<span class="mi">1</span>]

        <span class="n">conn</span>.<span class="n">ssl_env</span> = <span class="n">ssl_env</span>

        <span class="k">self</span>.<span class="n">requests</span>.<span class="n">put</span>(<span class="n">conn</span>)
    <span class="n">except</span> <span class="n">socket</span>.<span class="n">timeout:</span>
        <span class="c-Singleline"># The only reason for the timeout in start() is so we can</span>
        <span class="c-Singleline"># notice keyboard interrupts on Win32, which don&#39;t interrupt</span>
        <span class="c-Singleline"># accept() by default</span>
        <span class="k">return</span>
    <span class="n">except</span> <span class="n">socket</span>.<span class="n">error</span>, <span class="o">x</span>:
        <span class="k">if</span> <span class="k">self</span>.<span class="n">stats</span>[<span class="s">&#39;Enabled&#39;</span>]:
            <span class="k">self</span>.<span class="n">stats</span>[<span class="s">&#39;Socket Errors&#39;</span>] += <span class="mi">1</span>
        <span class="k">if</span> <span class="o">x</span>.<span class="n">args</span>[<span class="mi">0</span>] <span class="n">in</span> <span class="n">socket_error_eintr:</span>
            <span class="c-Singleline"># I *think* this is right. EINTR should occur when a signal</span>
            <span class="c-Singleline"># is received during the accept() call; all docs say retry</span>
            <span class="c-Singleline"># the call, and I *think* I&#39;m reading it right that Python</span>
            <span class="c-Singleline"># will then go ahead and poll for and handle the signal</span>
            <span class="c-Singleline"># elsewhere. See http://www.cherrypy.org/ticket/707.</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="o">x</span>.<span class="n">args</span>[<span class="mi">0</span>] <span class="n">in</span> <span class="n">socket_errors_nonblocking:</span>
            <span class="c-Singleline"># Just try again. See http://www.cherrypy.org/ticket/479.</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="o">x</span>.<span class="n">args</span>[<span class="mi">0</span>] <span class="n">in</span> <span class="n">socket_errors_to_ignore:</span>
            <span class="c-Singleline"># Our socket was closed.</span>
            <span class="c-Singleline"># See http://www.cherrypy.org/ticket/686.</span>
            <span class="k">return</span>
        <span class="n">raise</span>

<span class="n">def</span> <span class="n">_get_interrupt</span>(<span class="k">self</span>):
    <span class="k">return</span> <span class="k">self</span>.<span class="n">_interrupt</span>
<span class="n">def</span> <span class="n">_set_interrupt</span>(<span class="k">self</span>, <span class="n">interrupt</span>):
    <span class="k">self</span>.<span class="n">_interrupt</span> = <span class="nb">True</span>
    <span class="k">self</span>.<span class="n">stop</span>()
    <span class="k">self</span>.<span class="n">_interrupt</span> = <span class="n">interrupt</span>
<span class="n">interrupt</span> = <span class="n">property</span>(<span class="n">_get_interrupt</span>, <span class="n">_set_interrupt</span>,
                     <span class="n">doc</span>=<span class="s">&quot;Set this to an Exception instance to &quot;</span>
                         <span class="s">&quot;interrupt the server.&quot;</span>)

<span class="n">def</span> <span class="n">stop</span>(<span class="k">self</span>):
    <span class="s">&quot;&quot;&quot;Gracefully shutdown a server that is serving forever.&quot;&quot;&quot;</span>
    <span class="k">self</span>.<span class="n">ready</span> = <span class="nb">False</span>
    <span class="k">if</span> <span class="k">self</span>.<span class="n">_start_time</span> <span class="k">is</span> <span class="nb">not</span> <span class="n">None:</span>
        <span class="k">self</span>.<span class="n">_run_time</span> += (<span class="nb">time</span>.<span class="nb">time</span>() - <span class="k">self</span>.<span class="n">_start_time</span>)
    <span class="k">self</span>.<span class="n">_start_time</span> = <span class="n">None</span>

    <span class="n">sock</span> = <span class="n">getattr</span>(<span class="k">self</span>, <span class="s">&quot;socket&quot;</span>, <span class="n">None</span>)
    <span class="k">if</span> <span class="n">sock:</span>
        <span class="k">if</span> <span class="nb">not</span> <span class="n">isinstance</span>(<span class="k">self</span>.<span class="n">bind_addr</span>, <span class="n">basestring</span>):
            <span class="c-Singleline"># Touch our own socket to make accept() return immediately.</span>
            <span class="n">try:</span>
                <span class="n">host</span>, <span class="n">port</span> = <span class="n">sock</span>.<span class="n">getsockname</span>()[:<span class="mi">2</span>]
            <span class="n">except</span> <span class="n">socket</span>.<span class="n">error</span>, <span class="o">x</span>:
                <span class="k">if</span> <span class="o">x</span>.<span class="n">args</span>[<span class="mi">0</span>] <span class="nb">not</span> <span class="n">in</span> <span class="n">socket_errors_to_ignore:</span>
                    <span class="c-Singleline"># Changed to use error code and not message</span>
                    <span class="c-Singleline"># See http://www.cherrypy.org/ticket/860.</span>
                    <span class="n">raise</span>
            <span class="n">else:</span>
                <span class="c-Singleline"># Note that we&#39;re explicitly NOT using AI_PASSIVE,</span>
                <span class="c-Singleline"># here, because we want an actual IP to touch.</span>
                <span class="c-Singleline"># localhost won&#39;t work if we&#39;ve bound to a public IP,</span>
                <span class="c-Singleline"># but it will if we bound to &#39;0.0.0.0&#39; (INADDR_ANY).</span>
                <span class="k">for</span> <span class="n">res</span> <span class="n">in</span> <span class="n">socket</span>.<span class="n">getaddrinfo</span>(<span class="n">host</span>, <span class="n">port</span>, <span class="n">socket</span>.<span class="n">AF_UNSPEC</span>,
                                              <span class="n">socket</span>.<span class="n">SOCK_STREAM</span>):
                    <span class="n">af</span>, <span class="n">socktype</span>, <span class="k">proto</span>, <span class="n">canonname</span>, <span class="n">sa</span> = <span class="n">res</span>
                    <span class="o">s</span> = <span class="n">None</span>
                    <span class="n">try:</span>
                        <span class="o">s</span> = <span class="n">socket</span>.<span class="n">socket</span>(<span class="n">af</span>, <span class="n">socktype</span>, <span class="k">proto</span>)
                        <span class="c-Singleline"># See http://groups.google.com/group/cherrypy-users/</span>
                        <span class="c-Singleline">#        browse_frm/thread/bbfe5eb39c904fe0</span>
                        <span class="o">s</span>.<span class="n">settimeout</span>(<span class="mf">1.0</span>)
                        <span class="o">s</span>.<span class="nb">connect</span>((<span class="n">host</span>, <span class="n">port</span>))
                        <span class="o">s</span>.<span class="nb">close</span>()
                    <span class="n">except</span> <span class="n">socket</span>.<span class="n">error:</span>
                        <span class="k">if</span> <span class="o">s</span>:
                            <span class="o">s</span>.<span class="nb">close</span>()
        <span class="k">if</span> <span class="n">hasattr</span>(<span class="n">sock</span>, <span class="s">&quot;close&quot;</span>):
            <span class="n">sock</span>.<span class="nb">close</span>()
        <span class="k">self</span>.<span class="n">socket</span> = <span class="n">None</span>

    <span class="k">self</span>.<span class="n">requests</span>.<span class="n">stop</span>(<span class="k">self</span>.<span class="n">shutdown_timeout</span>)
</pre></div>


<p><strong>WorkerThread &amp;&amp; ThreadPool</strong>:<br />
下面要看cherry实现的线程池的一些细节点了。 <br />
    * <em>WorkerThread:</em> 维护一个线程的状态表并且唯一映射到master上，线程的结束依靠一个_SHUTDOWNREQUEST标记，每个线程对应一个。收到这个标记线程return。<br />
    * <em>ThreadPool:</em> <br />
        - <em>start:</em> 启动最小数目的threads <br />
        - <em>idle:</em> 获得目前空闲处理线程
        - <em>put:</em> 向queue中put connection
        - <em>grow:</em> Spawn new worker threads (not above self.max). 不能超过最大线程的前提下增长新的worker
        - <em>shrink:</em> Kill off worker threads (not below self.min). 先把dead的thread清除掉，然后减少Thead。</p>
<div class="highlight"><pre><span class="k">class</span> <span class="n">WorkerThread</span>(<span class="n">threading</span>.<span class="n">Thread</span>):
<span class="s">&quot;&quot;&quot;Thread which continuously polls a Queue for Connection objects.</span>

<span class="s">Due to the timing issues of polling a Queue, a WorkerThread does not</span>
<span class="s">check its own &#39;ready&#39; flag after it has started. To stop the thread,</span>
<span class="s">it is necessary to stick a _SHUTDOWNREQUEST object onto the Queue</span>
<span class="s">(one for each running WorkerThread).</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="n">conn</span> = <span class="n">None</span>
<span class="s">&quot;&quot;&quot;The current connection pulled off the Queue, or None.&quot;&quot;&quot;</span>

<span class="n">server</span> = <span class="n">None</span>
<span class="s">&quot;&quot;&quot;The HTTP Server which spawned this thread, and which owns the</span>
<span class="s">Queue and is placing active connections into it.&quot;&quot;&quot;</span>

<span class="n">ready</span> = <span class="nb">False</span>
<span class="s">&quot;&quot;&quot;A simple flag for the calling server to know when this thread</span>
<span class="s">has begun polling the Queue.&quot;&quot;&quot;</span>


<span class="n">def</span> <span class="n">__init__</span>(<span class="k">self</span>, <span class="n">server</span>):
    <span class="k">self</span>.<span class="n">ready</span> = <span class="nb">False</span>
    <span class="k">self</span>.<span class="n">server</span> = <span class="n">server</span>

    <span class="k">self</span>.<span class="n">requests_seen</span> = <span class="mi">0</span>
    <span class="k">self</span>.<span class="n">bytes_read</span> = <span class="mi">0</span>
    <span class="k">self</span>.<span class="n">bytes_written</span> = <span class="mi">0</span>
    <span class="k">self</span>.<span class="n">start_time</span> = <span class="n">None</span>
    <span class="k">self</span>.<span class="n">work_time</span> = <span class="mi">0</span>
    <span class="k">self</span>.<span class="n">stats</span> = {
        <span class="s">&#39;Requests&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: <span class="k">self</span>.<span class="n">requests_seen</span> + ((<span class="k">self</span>.<span class="n">start_time</span> <span class="k">is</span> <span class="n">None</span>) <span class="o">and</span> <span class="mi">0</span> <span class="o">or</span> <span class="k">self</span>.<span class="n">conn</span>.<span class="n">requests_seen</span>),
        <span class="s">&#39;Bytes Read&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: <span class="k">self</span>.<span class="n">bytes_read</span> + ((<span class="k">self</span>.<span class="n">start_time</span> <span class="k">is</span> <span class="n">None</span>) <span class="o">and</span> <span class="mi">0</span> <span class="o">or</span> <span class="k">self</span>.<span class="n">conn</span>.<span class="n">rfile</span>.<span class="n">bytes_read</span>),
        <span class="s">&#39;Bytes Written&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: <span class="k">self</span>.<span class="n">bytes_written</span> + ((<span class="k">self</span>.<span class="n">start_time</span> <span class="k">is</span> <span class="n">None</span>) <span class="o">and</span> <span class="mi">0</span> <span class="o">or</span> <span class="k">self</span>.<span class="n">conn</span>.<span class="n">wfile</span>.<span class="n">bytes_written</span>),
        <span class="s">&#39;Work Time&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: <span class="k">self</span>.<span class="n">work_time</span> + ((<span class="k">self</span>.<span class="n">start_time</span> <span class="k">is</span> <span class="n">None</span>) <span class="o">and</span> <span class="mi">0</span> <span class="o">or</span> <span class="nb">time</span>.<span class="nb">time</span>() - <span class="k">self</span>.<span class="n">start_time</span>),
        <span class="s">&#39;Read Throughput&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: <span class="o">s</span>[<span class="s">&#39;Bytes Read&#39;</span>](<span class="o">s</span>) / (<span class="o">s</span>[<span class="s">&#39;Work Time&#39;</span>](<span class="o">s</span>) <span class="o">or</span> <span class="mf">1e-6</span>),
        <span class="s">&#39;Write Throughput&#39;</span>: <span class="n">lambda</span> <span class="o">s</span>: <span class="o">s</span>[<span class="s">&#39;Bytes Written&#39;</span>](<span class="o">s</span>) / (<span class="o">s</span>[<span class="s">&#39;Work Time&#39;</span>](<span class="o">s</span>) <span class="o">or</span> <span class="mf">1e-6</span>),
    }
    <span class="n">threading</span>.<span class="n">Thread</span>.<span class="n">__init__</span>(<span class="k">self</span>)

<span class="n">def</span> <span class="nb">run</span>(<span class="k">self</span>):
    <span class="k">self</span>.<span class="n">server</span>.<span class="n">stats</span>[<span class="s">&#39;Worker Threads&#39;</span>][<span class="k">self</span>.<span class="n">getName</span>()] = <span class="k">self</span>.<span class="n">stats</span>
    <span class="n">try:</span>
        <span class="k">self</span>.<span class="n">ready</span> = <span class="nb">True</span>
        <span class="k">while</span> <span class="n">True:</span>
            <span class="n">conn</span> = <span class="k">self</span>.<span class="n">server</span>.<span class="n">requests</span>.<span class="n">get</span>()
            <span class="k">if</span> <span class="n">conn</span> <span class="k">is</span> <span class="n">_SHUTDOWNREQUEST:</span>
                <span class="k">return</span>

            <span class="k">self</span>.<span class="n">conn</span> = <span class="n">conn</span>
            <span class="k">if</span> <span class="k">self</span>.<span class="n">server</span>.<span class="n">stats</span>[<span class="s">&#39;Enabled&#39;</span>]:
                <span class="k">self</span>.<span class="n">start_time</span> = <span class="nb">time</span>.<span class="nb">time</span>()
            <span class="n">try:</span>
                <span class="n">conn</span>.<span class="n">communicate</span>()
            <span class="n">finally:</span>
                <span class="n">conn</span>.<span class="nb">close</span>()
                <span class="k">if</span> <span class="k">self</span>.<span class="n">server</span>.<span class="n">stats</span>[<span class="s">&#39;Enabled&#39;</span>]:
                    <span class="k">self</span>.<span class="n">requests_seen</span> += <span class="k">self</span>.<span class="n">conn</span>.<span class="n">requests_seen</span>
                    <span class="k">self</span>.<span class="n">bytes_read</span> += <span class="k">self</span>.<span class="n">conn</span>.<span class="n">rfile</span>.<span class="n">bytes_read</span>
                    <span class="k">self</span>.<span class="n">bytes_written</span> += <span class="k">self</span>.<span class="n">conn</span>.<span class="n">wfile</span>.<span class="n">bytes_written</span>
                    <span class="k">self</span>.<span class="n">work_time</span> += <span class="nb">time</span>.<span class="nb">time</span>() - <span class="k">self</span>.<span class="n">start_time</span>
                    <span class="k">self</span>.<span class="n">start_time</span> = <span class="n">None</span>
                <span class="k">self</span>.<span class="n">conn</span> = <span class="n">None</span>
    <span class="n">except</span> (<span class="n">KeyboardInterrupt</span>, <span class="n">SystemExit</span>), <span class="n">exc:</span>
        <span class="k">self</span>.<span class="n">server</span>.<span class="n">interrupt</span> = <span class="n">exc</span>

    <span class="k">class</span> <span class="n">ThreadPool</span>(<span class="n">object</span>):
<span class="s">&quot;&quot;&quot;A Request Queue for the CherryPyWSGIServer which pools threads.</span>

<span class="s">ThreadPool objects must provide min, get(), put(obj), start()</span>
<span class="s">and stop(timeout) attributes.</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="n">def</span> <span class="n">__init__</span>(<span class="k">self</span>, <span class="n">server</span>, <span class="nb">min</span>=<span class="mi">10</span>, <span class="nb">max</span>=-<span class="mi">1</span>):
    <span class="k">self</span>.<span class="n">server</span> = <span class="n">server</span>
    <span class="k">self</span>.<span class="nb">min</span> = <span class="nb">min</span>
    <span class="k">self</span>.<span class="nb">max</span> = <span class="nb">max</span>
    <span class="k">self</span>.<span class="n">_threads</span> = []
    <span class="k">self</span>.<span class="n">_queue</span> = <span class="n">Queue</span>.<span class="n">Queue</span>()
    <span class="k">self</span>.<span class="n">get</span> = <span class="k">self</span>.<span class="n">_queue</span>.<span class="n">get</span>

<span class="n">def</span> <span class="n">start</span>(<span class="k">self</span>):
    <span class="s">&quot;&quot;&quot;Start the pool of threads.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span>(<span class="k">self</span>.<span class="nb">min</span>):
        <span class="k">self</span>.<span class="n">_threads</span>.<span class="n">append</span>(<span class="n">WorkerThread</span>(<span class="k">self</span>.<span class="n">server</span>))
    <span class="k">for</span> <span class="n">worker</span> <span class="n">in</span> <span class="k">self</span>.<span class="n">_threads:</span>
        <span class="n">worker</span>.<span class="n">setName</span>(<span class="s">&quot;CP Server &quot;</span> + <span class="n">worker</span>.<span class="n">getName</span>())
        <span class="n">worker</span>.<span class="n">start</span>()
    <span class="k">for</span> <span class="n">worker</span> <span class="n">in</span> <span class="k">self</span>.<span class="n">_threads:</span>
        <span class="k">while</span> <span class="nb">not</span> <span class="n">worker</span>.<span class="n">ready:</span>
            <span class="nb">time</span>.<span class="nb">sleep</span>(<span class="mf">.1</span>)

<span class="n">def</span> <span class="n">_get_idle</span>(<span class="k">self</span>):
    <span class="s">&quot;&quot;&quot;Number of worker threads which are idle. Read-only.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">len</span>([<span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="n">in</span> <span class="k">self</span>.<span class="n">_threads</span> <span class="k">if</span> <span class="n">t</span>.<span class="n">conn</span> <span class="k">is</span> <span class="n">None</span>])
<span class="n">idle</span> = <span class="n">property</span>(<span class="n">_get_idle</span>, <span class="n">doc</span>=<span class="n">_get_idle</span>.<span class="n">__doc__</span>)

<span class="n">def</span> <span class="n">put</span>(<span class="k">self</span>, <span class="n">obj</span>):
    <span class="k">self</span>.<span class="n">_queue</span>.<span class="n">put</span>(<span class="n">obj</span>)
    <span class="k">if</span> <span class="n">obj</span> <span class="k">is</span> <span class="n">_SHUTDOWNREQUEST:</span>
        <span class="k">return</span>

<span class="n">def</span> <span class="n">grow</span>(<span class="k">self</span>, <span class="n">amount</span>):
    <span class="s">&quot;&quot;&quot;Spawn new worker threads (not above self.max).&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span>(<span class="n">amount</span>):
        <span class="k">if</span> <span class="k">self</span>.<span class="nb">max</span> &gt; <span class="mi">0</span> <span class="o">and</span> <span class="n">len</span>(<span class="k">self</span>.<span class="n">_threads</span>) &gt;= <span class="k">self</span>.<span class="o">max</span>:
            <span class="k">break</span>
        <span class="n">worker</span> = <span class="n">WorkerThread</span>(<span class="k">self</span>.<span class="n">server</span>)
        <span class="n">worker</span>.<span class="n">setName</span>(<span class="s">&quot;CP Server &quot;</span> + <span class="n">worker</span>.<span class="n">getName</span>())
        <span class="k">self</span>.<span class="n">_threads</span>.<span class="n">append</span>(<span class="n">worker</span>)
        <span class="n">worker</span>.<span class="n">start</span>()

<span class="n">def</span> <span class="n">shrink</span>(<span class="k">self</span>, <span class="n">amount</span>):
    <span class="s">&quot;&quot;&quot;Kill off worker threads (not below self.min).&quot;&quot;&quot;</span>
    <span class="c-Singleline"># Grow/shrink the pool if necessary.</span>
    <span class="c-Singleline"># Remove any dead threads from our list</span>
    <span class="k">for</span> <span class="n">t</span> <span class="n">in</span> <span class="k">self</span>.<span class="n">_threads:</span>
        <span class="k">if</span> <span class="nb">not</span> <span class="n">t</span>.<span class="n">isAlive</span>():
            <span class="k">self</span>.<span class="n">_threads</span>.<span class="n">remove</span>(<span class="n">t</span>)
            <span class="n">amount</span> -= <span class="mi">1</span>

    <span class="k">if</span> <span class="n">amount</span> &gt; <span class="mi">0</span>:
        <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span>(<span class="nb">min</span>(<span class="n">amount</span>, <span class="n">len</span>(<span class="k">self</span>.<span class="n">_threads</span>) - <span class="k">self</span>.<span class="nb">min</span>)):
            <span class="c-Singleline"># Put a number of shutdown requests on the queue equal</span>
            <span class="c-Singleline"># to &#39;amount&#39;. Once each of those is processed by a worker,</span>
            <span class="c-Singleline"># that worker will terminate and be culled from our list</span>
            <span class="c-Singleline"># in self.put.</span>
            <span class="k">self</span>.<span class="n">_queue</span>.<span class="n">put</span>(<span class="n">_SHUTDOWNREQUEST</span>)

<span class="n">def</span> <span class="n">stop</span>(<span class="k">self</span>, <span class="n">timeout</span>=<span class="mi">5</span>):
    <span class="c-Singleline"># Must shut down threads here so the code that calls</span>
    <span class="c-Singleline"># this method can know when all threads are stopped.</span>
    <span class="k">for</span> <span class="n">worker</span> <span class="n">in</span> <span class="k">self</span>.<span class="n">_threads:</span>
        <span class="k">self</span>.<span class="n">_queue</span>.<span class="n">put</span>(<span class="n">_SHUTDOWNREQUEST</span>)

    <span class="c-Singleline"># Don&#39;t join currentThread (when stop is called inside a request).</span>
    <span class="n">current</span> = <span class="n">threading</span>.<span class="n">currentThread</span>()
    <span class="k">if</span> <span class="n">timeout</span> <span class="o">and</span> <span class="n">timeout</span> &gt;= <span class="mi">0</span>:
        <span class="n">endtime</span> = <span class="nb">time</span>.<span class="nb">time</span>() + <span class="n">timeout</span>
    <span class="k">while</span> <span class="k">self</span>.<span class="n">_threads:</span>
        <span class="n">worker</span> = <span class="k">self</span>.<span class="n">_threads</span>.<span class="nb">pop</span>()
        <span class="k">if</span> <span class="n">worker</span> <span class="k">is</span> <span class="nb">not</span> <span class="n">current</span> <span class="o">and</span> <span class="n">worker</span>.<span class="n">isAlive</span>():
            <span class="n">try:</span>
                <span class="k">if</span> <span class="n">timeout</span> <span class="k">is</span> <span class="n">None</span> <span class="o">or</span> <span class="n">timeout</span> &lt; <span class="mi">0</span>:
                    <span class="n">worker</span>.<span class="nb">join</span>()
                <span class="n">else:</span>
                    <span class="n">remaining_time</span> = <span class="n">endtime</span> - <span class="nb">time</span>.<span class="nb">time</span>()
                    <span class="k">if</span> <span class="n">remaining_time</span> &gt; <span class="mi">0</span>:
                        <span class="n">worker</span>.<span class="nb">join</span>(<span class="n">remaining_time</span>)
                    <span class="k">if</span> <span class="n">worker</span>.<span class="n">isAlive</span>():
                        <span class="c-Singleline"># We exhausted the timeout.</span>
                        <span class="c-Singleline"># Forcibly shut down the socket.</span>
                        <span class="n">c</span> = <span class="n">worker</span>.<span class="n">conn</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="o">and</span> <span class="nb">not</span> <span class="n">c</span>.<span class="n">rfile</span>.<span class="n">closed:</span>
                            <span class="n">try:</span>
                                <span class="n">c</span>.<span class="n">socket</span>.<span class="n">shutdown</span>(<span class="n">socket</span>.<span class="n">SHUT_RD</span>)
                            <span class="n">except</span> <span class="n">TypeError:</span>
                                <span class="c-Singleline"># pyOpenSSL sockets don&#39;t take an arg</span>
                                <span class="n">c</span>.<span class="n">socket</span>.<span class="n">shutdown</span>()
                        <span class="n">worker</span>.<span class="nb">join</span>()
            <span class="n">except</span> (<span class="n">AssertionError</span>,
                    <span class="c-Singleline"># Ignore repeated Ctrl-C.</span>
                    <span class="c-Singleline"># See http://www.cherrypy.org/ticket/691.</span>
                    <span class="n">KeyboardInterrupt</span>), <span class="n">exc1:</span>
                <span class="nb">pass</span>

<span class="n">def</span> <span class="n">_get_qsize</span>(<span class="k">self</span>):
    <span class="k">return</span> <span class="k">self</span>.<span class="n">_queue</span>.<span class="n">qsize</span>()
<span class="n">qsize</span> = <span class="n">property</span>(<span class="n">_get_qsize</span>)
</pre></div>


<p><strong>WSGIGateWay &amp; WSGIPathInfoDispatcher</strong>: <br />
WSGI上场了，其实你看了前面所有的实现，就应该还有点疑问，respond怎么提高扩展性，对不同的route做出不同的response呢？ <br />
WSGIPathInfoDispathcher能帮你实现，来让我们看看他们是怎们实现的。 <br />
先看<strong>WSGIPathInfoDispatcher</strong>:   </p>
<div class="highlight"><pre>* _init:_ 对不同的(route, func)进行排序，路径长的排序在前，很容易理解，更具体的应该首先被处理，另对path最后的slash去掉处理。     
* _call:_ 对应WSGI的标准方法，轮询所有的request的path去匹配预设的paths。
</pre></div>


<p>再看<strong>WSGIGateway</strong>:</p>
<div class="highlight"><pre>* _init:_ 获取HTTPRequest
* _respond:_ 首先调用传给保留在server的WSGIfunc的hookfunc——start_response来获取用户设置的状态码和outheaders，返回write方法。用户可自行调用write方法去response，如果不调用，也可以return返回数据。然后从request标准化出来的environ和response来调用WSGIfunc获得要response的数据并发送headers和write。   
* _start_response:_ 标准实现的发送状态码和headers的程序。

class WSGIPathInfoDispatcher(object):
&quot;&quot;&quot;A WSGI dispatcher for dispatch based on the PATH_INFO.

apps: a dict or list of (path_prefix, app) pairs.
&quot;&quot;&quot;

def __init__(self, apps):
    try:
        apps = apps.items()
    except AttributeError:
        pass

    # Sort the apps by len(path), descending
    apps.sort(cmp=lambda x,y: cmp(len(x[0]), len(y[0])))
    apps.reverse()

    # The path_prefix strings must start, but not end, with a slash.
    # Use &quot;&quot; instead of &quot;/&quot;.
    self.apps = [(p.rstrip(&quot;/&quot;), a) for p, a in apps]

def __call__(self, environ, start_response):
    path = environ[&quot;PATH_INFO&quot;] or &quot;/&quot;
    for p, app in self.apps:
        # The apps list should be sorted by length, descending.
        if path.startswith(p + &quot;/&quot;) or path == p:
            environ = environ.copy()
            environ[&quot;SCRIPT_NAME&quot;] = environ[&quot;SCRIPT_NAME&quot;] + p
            environ[&quot;PATH_INFO&quot;] = path[len(p):]
            return app(environ, start_response)

    start_response(&#39;404 Not Found&#39;, [(&#39;Content-Type&#39;, &#39;text/plain&#39;),
                                     (&#39;Content-Length&#39;, &#39;0&#39;)])
    return [&#39;&#39;]

class WSGIGateway(Gateway):
def __init__(self, req):
    self.req = req
    self.started_response = False
    self.env = self.get_environ()
    self.remaining_bytes_out = None

def get_environ(self):
    &quot;&quot;&quot;Return a new environ dict targeting the given wsgi.version&quot;&quot;&quot;
    raise NotImplemented

def respond(self):
    response = self.req.server.wsgi_app(self.env, self.start_response)
    try:
        for chunk in response:
            # &quot;The start_response callable must not actually transmit
            # the response headers. Instead, it must store them for the
            # server or gateway to transmit only after the first
            # iteration of the application return value that yields
            # a NON-EMPTY string, or upon the application&#39;s first
            # invocation of the write() callable.&quot; (PEP 333)
            if chunk:
                if isinstance(chunk, unicode):
                    chunk = chunk.encode(&#39;ISO-8859-1&#39;)
                self.write(chunk)
    finally:
        if hasattr(response, &quot;close&quot;):
            response.close()

def start_response(self, status, headers, exc_info = None):
    &quot;&quot;&quot;WSGI callable to begin the HTTP response.&quot;&quot;&quot;
    # &quot;The application may call start_response more than once,
    # if and only if the exc_info argument is provided.&quot;
    if self.started_response and not exc_info:
        raise AssertionError(&quot;WSGI start_response called a second &quot;
                             &quot;time with no exc_info.&quot;)
    self.started_response = True

    # &quot;if exc_info is provided, and the HTTP headers have already been
    # sent, start_response must raise an error, and should raise the
    # exc_info tuple.&quot;
    if self.req.sent_headers:
        try:
            raise exc_info[0], exc_info[1], exc_info[2]
        finally:
            exc_info = None

    self.req.status = status
    for k, v in headers:
        if not isinstance(k, str):
            raise TypeError(&quot;WSGI response header key %r is not a byte string.&quot; % k)
        if not isinstance(v, str):
            raise TypeError(&quot;WSGI response header value %r is not a byte string.&quot; % v)
        if k.lower() == &#39;content-length&#39;:
            self.remaining_bytes_out = int(v)
    self.req.outheaders.extend(headers)

    return self.write

def write(self, chunk):
    &quot;&quot;&quot;WSGI callable to write unbuffered data to the client.

    This method is also used internally by start_response (to write
    data from the iterable returned by the WSGI application).
    &quot;&quot;&quot;
    if not self.started_response:
        raise AssertionError(&quot;WSGI write called before start_response.&quot;)

    chunklen = len(chunk)
    rbo = self.remaining_bytes_out
    if rbo is not None and chunklen &gt; rbo:
        if not self.req.sent_headers:
            # Whew. We can send a 500 to the client.
            self.req.simple_response(&quot;500 Internal Server Error&quot;,
                &quot;The requested resource returned more bytes than the &quot;
                &quot;declared Content-Length.&quot;)
        else:
            # Dang. We have probably already sent data. Truncate the chunk
            # to fit (so the client doesn&#39;t hang) and raise an error later.
            chunk = chunk[:rbo]

    if not self.req.sent_headers:
        self.req.sent_headers = True
        self.req.send_headers()

    self.req.write(chunk)

    if rbo is not None:
        rbo -= chunklen
        if rbo &lt; 0:
            raise ValueError(
                &quot;Response body exceeds the declared Content-Length.&quot;)
</pre></div>


<p>自此cherrypy的WSGIHTTPServer除了ssl部分就基本上就打通了，整个代码简单易读，有良好的设计模式，代码容错性好，对我很有启发性，感觉自己实现的那个真的是拿不出手。 
不过，个人感觉作者的实现抽象上还可以提高，有些func仍然可以继续抽象。   </p>
<h4><strong>1.3.5 net.py</strong><span id="1.3.5"></span></h4>
<p>主要是一些对于ip，port合法性检查和Web的编码转换操作，是一个工具库。 <br />
@| +htmlquote : function                                       <br />
@|
@| +htmlunquote : function
@|
@| +httpdate : function
@|
@| +parsehttpdate : function                                                    <br />
@|
@| +urlquote : function
@|
@| +validaddr : function
@|
@| +validip : function
@|
@| +validip6addr : function                                                     <br />
@|
@| +validipaddr : function                                                      <br />
@|
@| +validipport : function
@|
@| +websafe : function</p>
<h4><strong>1.3.6 browser.py</strong><span id="1.3.6"></span></h4>
<p>这个简直以后不用不用再随便造python的<strong>抓取器</strong>了啊，有这么好的实现。  <br />
TODO：等我研究透了&amp;&amp;转化成我的东西之后，再加上。</p>
<h4><strong>1.3.7 template.py</strong><span id="1.3.7"></span></h4>
<p>webpy还自己实现了一套template...</p>
<h4><strong>1.3.8 session.py</strong><span id="1.3.8"></span></h4>
<p>管理session。</p>
            
            <section>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                href="http://aleda.cn/article/2015/08/web.py/#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'aleda';
        var disqus_identifier = 'http://aleda.cn/article/2015/08/web.py/';
    var disqus_url = 'http://aleda.cn/article/2015/08/web.py/';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
            </div>
        </div>
    </div>
</div>
</section>

            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2015-08-30T22:22:00+08:00">Aug 30, 2015</time>
            <h4>Category</h4>
            <a class="category-link" href="http://aleda.cn/categories.html#code-reading-ref">code-reading</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="http://aleda.cn/tags.html#code-reading-ref">code-reading
                    <span>8</span>
</a></li>
                <li><a href="http://aleda.cn/tags.html#experience-ref">experience
                    <span>12</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="http://github.com/Aleda" title="My Github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="mailto:aledalee@foxmail.com" title="My Email Address" class="sidebar-social-links" target="_blank">
    <i class="fa fa-envelope sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

            <script type="text/javascript">
var disqus_shortname = 'aleda';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script  language="javascript" type="text/javascript">
function uncollapse() {
    if (window.location.hash.match(/^#comment-\d+$/)) {
        $('#disqus_thread').collapse('show');
    }
}
</script>
<script type="text/javascript" language="JavaScript">
uncollapse();
window.onhashchange=function(){
    if (window.location.hash.match(/^#comment-\d+$/))
        window.location.reload(true);
}
</script>
<script>
$('#disqus_thread').on('shown', function () {
    var link = document.getElementsByClassName('accordion-toggle');
    var old_innerHTML = link[0].innerHTML;
    $(link[0]).fadeOut(500, function() {
        $(this).text('Click here to hide comments').fadeIn(500);
    });
    $('#disqus_thread').on('hidden', function () {
        $(link[0]).fadeOut(500, function() {
            $(this).text(old_innerHTML).fadeIn(500);
        });
    })
})
</script>


    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>